<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>/Volumes/Users/johnh/Documents/ObjCpp/objsql.mm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/Volumes/Users/johnh/Documents/ObjCpp/objsql.mm</h1><a href="objsql_8mm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *  objsql.m - implementaion simple persistence layer using objcpp.h</span>
<a name="l00003"></a>00003 <span class="comment"> *  ========</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Created by John Holdsworth on 01/04/2009.</span>
<a name="l00006"></a>00006 <span class="comment"> *  Copyright 2009 John Holdsworth.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *  $Id: //depot/ObjCpp/objsql.mm#45 $</span>
<a name="l00009"></a>00009 <span class="comment"> *  $DateTime: 2009/11/16 15:15:48 $</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *  C++ classes to wrap up XCode classes for operator overload of</span>
<a name="l00012"></a>00012 <span class="comment"> *  useful operations such as access to NSArrays and NSDictionary</span>
<a name="l00013"></a>00013 <span class="comment"> *  by subscript or NSString operators such as + for concatenation.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> *  This works as the Apple Objective-C compiler supports source</span>
<a name="l00016"></a>00016 <span class="comment"> *  which mixes C++ with objective C. To enable this: for each</span>
<a name="l00017"></a>00017 <span class="comment"> *  source file which will include/import this header file, select</span>
<a name="l00018"></a>00018 <span class="comment"> *  it in Xcode and open it's "Info". To enable mixed compilation,</span>
<a name="l00019"></a>00019 <span class="comment"> *  for the file's "File Type" select: "sourcecode.cpp.objcpp".</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> *  For bugs or ommisions please email objcpp@johnholdsworth.com</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> *  Home page for updates and docs: http://objcpp.johnholdsworth.com</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> *  Forum for support: http://n2.nabble.com/Objcpp-Q-A-f2626793.html </span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> *  You may make commercial use of this source in applications without</span>
<a name="l00028"></a>00028 <span class="comment"> *  charge but not sell it as source nor can you remove this notice from</span>
<a name="l00029"></a>00029 <span class="comment"> *  this source if you redistribute. You can make any changes you like</span>
<a name="l00030"></a>00030 <span class="comment"> *  to this code before redistribution but please annotate them below.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> *  If you find it useful please send a donation via paypal to account</span>
<a name="l00033"></a>00033 <span class="comment"> *  objcpp@johnholdsworth.com. Thanks.</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> *  THIS CODE IS PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND EITHER</span>
<a name="l00036"></a>00036 <span class="comment"> *  EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED </span>
<a name="l00037"></a>00037 <span class="comment"> *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> *  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING</span>
<a name="l00040"></a>00040 <span class="comment"> *  WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS</span>
<a name="l00041"></a>00041 <span class="comment"> *  THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING</span>
<a name="l00042"></a>00042 <span class="comment"> *  ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT</span>
<a name="l00043"></a>00043 <span class="comment"> *  OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED</span>
<a name="l00044"></a>00044 <span class="comment"> *  TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED </span>
<a name="l00045"></a>00045 <span class="comment"> *  BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH </span>
<a name="l00046"></a>00046 <span class="comment"> *  ANY OTHER PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN</span>
<a name="l00047"></a>00047 <span class="comment"> *  ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#import &lt;objc/runtime.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#import &lt;sqlite3.h&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#import "<a class="code" href="objsql_8h.html">objsql.h</a>"</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#if 0</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#ifdef OODEBUG</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#define OODEBUG_SQL  1</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="objsql_8mm.html#a5cb44019357427af6d796c98fffcbe7">00062</a> <a class="code" href="class_o_o_o_o_database.html">OOOODatabase</a> <a class="code" href="objsql_8h.html#0bfc1d7b40fa2703a9f1b4965c572212">OODB</a>;
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#pragma mark OORecord abstract superclass for records</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="keyword">@implementation </span><a class="code" href="interface_o_o_record.html">OORecord</a>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="interface_o_o_record.html#09fc8d536ab7aa423b4cc5ecaaddc59a">00068</a> + (id)<a class="code" href="interface_o_o_record.html#09fc8d536ab7aa423b4cc5ecaaddc59a">insert</a> { 
<a name="l00069"></a>00069     <a class="code" href="interface_o_o_record.html">OORecord</a> *<a class="code" href="interface_o_o_record.html#e54a4d83d22e0bf3aae16a8eff0ef457">record</a> = [[<span class="keyword">self</span> alloc] init];
<a name="l00070"></a>00070     [record <a class="code" href="interface_o_o_record.html#09fc8d536ab7aa423b4cc5ecaaddc59a">insert</a>];
<a name="l00071"></a>00071     [record release];
<a name="l00072"></a>00072     <span class="keywordflow">return</span> record;  
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="interface_o_o_record.html#d24157e0c3bb4f0bc73d7b1b6a85849c">00075</a> + (id)insertWithParent:(<span class="keywordtype">id</span>)parent {
<a name="l00076"></a>00076     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#c2241d1dedefbd157d0e4732551f4183">copyJoinKeysFrom</a>:parent <a class="code" href="interface_o_o_database.html#c2241d1dedefbd157d0e4732551f4183">to</a>:[<span class="keyword">self</span> <a class="code" href="interface_o_o_record.html#09fc8d536ab7aa423b4cc5ecaaddc59a">insert</a>]];
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 - (id)<a class="code" href="interface_o_o_record.html#09fc8d536ab7aa423b4cc5ecaaddc59a">insert</a> { [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#2b379c2906e1882177b10be7a454d4c9">insert</a>:self]; <span class="keywordflow">return</span> <span class="keyword">self</span>; }
<a name="l00080"></a><a class="code" href="interface_o_o_record.html#0664f1557270786fc193ebf2e18c6849">00080</a> - (id)<a class="code" href="interface_o_o_record.html#0664f1557270786fc193ebf2e18c6849">delete</a> { [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#48acd94d9ec15cd12f18d5a9ce61612b">delete</a>:self]; <span class="keywordflow">return</span> <span class="keyword">self</span>; }
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="interface_o_o_record.html#ff492e0cd302a97d6f4213eabb68234c">00082</a> - (void)<a class="code" href="interface_o_o_record.html#ff492e0cd302a97d6f4213eabb68234c">update</a> { [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#c0c153636f958053cc6677bad7974eeb">update</a>:self]; }
<a name="l00083"></a><a class="code" href="interface_o_o_record.html#24355703820555a0740024e05aac239b">00083</a> - (void)<a class="code" href="interface_o_o_record.html#24355703820555a0740024e05aac239b">indate</a> { [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#7a9d18a556a8f19dd0c18ca35c214a49">indate</a>:self]; }
<a name="l00084"></a><a class="code" href="interface_o_o_record.html#d909de829e801d7c2c47c36884fcbfc7">00084</a> - (void)<a class="code" href="interface_o_o_record.html#d909de829e801d7c2c47c36884fcbfc7">upsert</a> { [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#f79017a60a9d4057b7a50bb13f7d6517">upsert</a>:self]; }
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="interface_o_o_record.html#2e77b49838f2dd9ff57e913e785261ca">00086</a> - (int)<a class="code" href="interface_o_o_record.html#2e77b49838f2dd9ff57e913e785261ca">commit</a> { <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">commit</a>]; }
<a name="l00087"></a><a class="code" href="interface_o_o_record.html#c9c890213f6200e505bd61ca3fc357bc">00087</a> - (int)<a class="code" href="interface_o_o_record.html#c9c890213f6200e505bd61ca3fc357bc">rollback</a> { <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#9ed5468dde81867b4daa903ea5249a61">rollback</a>]; }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">// to handle null values for ints, floats etc.</span>
<a name="l00090"></a><a class="code" href="interface_o_o_record.html#02477144b4959dc4cd645fc0e97444f7">00090</a> - (void)setNilValueForKey:(NSString *)key {
<a name="l00091"></a>00091     <span class="keyword">static</span> <a class="code" href="class_o_o_reference.html">OOReference&lt;NSValue *&gt;</a> zeroForNull;
<a name="l00092"></a>00092     <span class="keywordflow">if</span> ( !zeroForNull )
<a name="l00093"></a>00093         zeroForNull = [NSNumber numberWithInt:0];
<a name="l00094"></a>00094     [<span class="keyword">self</span> setValue:zeroForNull forKey:key];
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="interface_o_o_record.html#1dfb9c9e0244780cfc2eefb2e4e46fd7">00097</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)<a class="code" href="interface_o_o_record.html#1dfb9c9e0244780cfc2eefb2e4e46fd7">select</a> {
<a name="l00098"></a>00098     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:nil <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:self <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:nil];
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="interface_o_o_record.html#a795cde83537f95abcb260aca10dd73d">00101</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)<a class="code" href="interface_o_o_record.html#1dfb9c9e0244780cfc2eefb2e4e46fd7">select</a>:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)sql {
<a name="l00102"></a>00102     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:sql <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:self <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:nil];
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="interface_o_o_record.html#04d45d80a6e755b22afd3c9d3a644522">00105</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)selectRecordsRelatedTo:(<span class="keywordtype">id</span>)parent {
<a name="l00106"></a>00106     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:nil <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:self <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:parent];
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="interface_o_o_record.html#e54a4d83d22e0bf3aae16a8eff0ef457">00109</a> + (id)record {
<a name="l00110"></a>00110     <span class="keywordflow">return</span> [[[<span class="keyword">self</span> alloc] init] autorelease];
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)<a class="code" href="interface_o_o_record.html#1dfb9c9e0244780cfc2eefb2e4e46fd7">select</a> {
<a name="l00114"></a>00114     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:nil <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:[<span class="keyword">self</span> class] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:self];
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 <span class="comment"></span>
<a name="l00117"></a>00117 <span class="comment">/**</span>
<a name="l00118"></a>00118 <span class="comment"> import a flat file with column values separated by the delimiter specified into </span>
<a name="l00119"></a>00119 <span class="comment"> the table associated with this class.</span>
<a name="l00120"></a>00120 <span class="comment"> */</span>
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="interface_o_o_record.html#55e6376e4051aeeef9dfdcf32db634cd">00122</a> + (int)importFrom:(const <a class="code" href="class_o_o_file.html">OOFile</a> &amp;)file delimiter:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)delim {
<a name="l00123"></a>00123     <a class="code" href="class_o_o_array.html">OOArray&lt;id&gt;</a> rows = [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#d2369ad36e4b1daf4c967460147958cd">import</a>:file.string() <a class="code" href="interface_o_o_meta_data.html#d2369ad36e4b1daf4c967460147958cd">intoClass</a>:self <a class="code" href="interface_o_o_meta_data.html#d2369ad36e4b1daf4c967460147958cd">delimiter</a>:delim];
<a name="l00124"></a>00124     [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#ecd60a49ad0804a927486a8d8af577fe">insertArray</a>:rows];
<a name="l00125"></a>00125     <span class="keywordflow">return</span> [<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">commit</a>];
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 <span class="comment"></span>
<a name="l00128"></a>00128 <span class="comment">/**</span>
<a name="l00129"></a>00129 <span class="comment"> Export a flat file with all rows in the table associated with the record subclass.</span>
<a name="l00130"></a>00130 <span class="comment"> */</span>
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="interface_o_o_record.html#df32cd5ade2865ba1ac4f82111186bcf">00132</a> + (BOOL)exportTo:(const <a class="code" href="class_o_o_file.html">OOFile</a> &amp;)file delimiter:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)delim {
<a name="l00133"></a>00133     <span class="keywordflow">return</span> file.<a class="code" href="class_o_o_file.html#ef28cba2cae7de08d25cb5a4c8e52ef6">save</a>( [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> export:[<span class="keyword">self</span> <a class="code" href="interface_o_o_record.html#1dfb9c9e0244780cfc2eefb2e4e46fd7">select</a>] delimiter:delim] );
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 <span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">/**</span>
<a name="l00137"></a>00137 <span class="comment"> populate a view with the string values taken from the ivars of the record</span>
<a name="l00138"></a>00138 <span class="comment"> */</span>
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="interface_o_o_record.html#c1ccd5448219ca8038dc8f4ef46458fc">00140</a> - (void)bindToView:(UIView *)view delegate:(<span class="keywordtype">id</span>)delegate {
<a name="l00141"></a>00141     [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#7c6e31e9eaaebdb3acbf10e3adda1274">bindRecord</a>:self <a class="code" href="interface_o_o_meta_data.html#7c6e31e9eaaebdb3acbf10e3adda1274">toView</a>:view <a class="code" href="interface_o_o_meta_data.html#7c6e31e9eaaebdb3acbf10e3adda1274">delegate</a>:delegate];
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 <span class="comment"></span>
<a name="l00144"></a>00144 <span class="comment">/**</span>
<a name="l00145"></a>00145 <span class="comment"> When the delegate method os sent use this method to update the record's values</span>
<a name="l00146"></a>00146 <span class="comment"> */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="interface_o_o_record.html#3e05330965b6277a30351e6fba861a9d">00148</a> - (void)updateFromView:(UIView *)view {
<a name="l00149"></a>00149     [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#490c4a66a3e7b4838a4d26c29bed80d0">updateRecord</a>:self <a class="code" href="interface_o_o_meta_data.html#490c4a66a3e7b4838a4d26c29bed80d0">fromView</a>:view];
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 <span class="comment"></span>
<a name="l00152"></a>00152 <span class="comment">/**</span>
<a name="l00153"></a>00153 <span class="comment"> Default description is dictionary containing values of all ivars</span>
<a name="l00154"></a>00154 <span class="comment"> */</span>
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="interface_o_o_record.html#6a162efb1943fbadaadf28d117eb6608">00156</a> - (NSString *)<a class="code" href="interface_o_o_record.html#6a162efb1943fbadaadf28d117eb6608">description</a> {
<a name="l00157"></a>00157     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#0012b40d1d8a15794dcf30d1e9fcd175">metaDataForClass</a>:[<span class="keyword">self</span> class]];
<a name="l00158"></a>00158     <span class="comment">// hack required where record contains a field "description" to avoid recursion</span>
<a name="l00159"></a>00159     <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> ivars; ivars &lt;&lt;= *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#09839852ef0397fdd8fb12034d965d79">ivars</a>; ivars -= <span class="stringliteral">"description"</span>;
<a name="l00160"></a>00160     <span class="keywordflow">return</span> [*[metaData <a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">encode</a>:[<span class="keyword">self</span> dictionaryWithValuesForKeys:ivars]] description];
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="keyword">@end</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="preprocessor">#pragma mark OOAdaptor - all methods required by objsql to access a database</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00167"></a>00167 <span class="comment">/**</span>
<a name="l00168"></a>00168 <span class="comment"> An internal class representing the interface to a particular database, in this case sqlite3.</span>
<a name="l00169"></a>00169 <span class="comment"> */</span>
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="interface_o_o_adaptor.html">00171</a> <span class="keyword">@interface </span><a class="code" href="interface_o_o_adaptor.html">OOAdaptor</a> : NSObject {
<a name="l00172"></a><a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">00172</a>     <a class="code" href="interface_o_o_database.html">OODatabase</a> *<a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>;
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="interface_o_o_adaptor.html#80f5a94ee8eab6e8bd7491138c088b98">00174</a>     sqlite3 *<a class="code" href="interface_o_o_adaptor.html#80f5a94ee8eab6e8bd7491138c088b98">db</a>;
<a name="l00175"></a><a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">00175</a>     sqlite3_stmt *<a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>;
<a name="l00176"></a>00176     <span class="keyword">struct </span>_str_link { 
<a name="l00177"></a>00177         <span class="keyword">struct </span>_str_link *next; <span class="keywordtype">char</span> str[1]; 
<a name="l00178"></a>00178     } *<a class="code" href="interface_o_o_adaptor.html#1644ba1a09de66737511ec8c21c73ff1">strs</a>;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 - (<a class="code" href="interface_o_o_adaptor.html">OOAdaptor</a> *)initPath:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)path database:(<a class="code" href="interface_o_o_database.html">OODatabase</a> *)database;
<a name="l00182"></a>00182 - (BOOL)prepare:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)sql;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 - (BOOL)bindCols:(const <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> &amp;)columns values:(const <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt; &amp;)values startingAt:(<span class="keywordtype">int</span>)pno bindNulls:(BOOL)bindNulls;
<a name="l00185"></a>00185 - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)bindResultsIntoInstancesOfClass:(Class)recordClass metaData:(<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *)metaData;
<a name="l00186"></a>00186 - (sqlite_int64)lastInsertRowID;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="keyword">@end</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keyword">@interface </span>NSData(OOExtras)
<a name="l00191"></a>00191 - initWithDescription:(NSString *)description;
<a name="l00192"></a>00192 <span class="keyword">@end</span>
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="preprocessor">#pragma mark OODatabase is the low level interface to a particular database</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>
<a name="l00196"></a>00196 <span class="keyword">@implementation </span><a class="code" href="interface_o_o_database.html">OODatabase</a>
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keyword">static</span> <a class="code" href="class_o_o_reference.html">OOReference&lt;OODatabase *&gt;</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>;
<a name="l00199"></a>00199 <span class="comment"></span>
<a name="l00200"></a>00200 <span class="comment">/**</span>
<a name="l00201"></a>00201 <span class="comment"> By default database file is "objsql.db" in the user/application's "Documents" directory</span>
<a name="l00202"></a>00202 <span class="comment"> and a single shared OODatabase instance used for all db operations.</span>
<a name="l00203"></a>00203 <span class="comment"> */</span>
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">00205</a> + (<a class="code" href="interface_o_o_database.html">OODatabase</a> *)sharedInstance {
<a name="l00206"></a>00206     <span class="keywordflow">return</span> !sharedInstance ? 
<a name="l00207"></a>00207     [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#fb1638e497eedf6f53f94a4166274a28">sharedInstanceForPath</a>:OODocument("objsql.db").path()] : *sharedInstance;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 <span class="comment"></span>
<a name="l00210"></a>00210 <span class="comment">/**</span>
<a name="l00211"></a>00211 <span class="comment"> Shared instance can be switched between any file paths.</span>
<a name="l00212"></a>00212 <span class="comment"> */</span>
<a name="l00213"></a>00213  
<a name="l00214"></a><a class="code" href="interface_o_o_database.html#fb1638e497eedf6f53f94a4166274a28">00214</a>  + (<a class="code" href="interface_o_o_database.html">OODatabase</a> *)sharedInstanceForPath:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)path {
<a name="l00215"></a>00215      [sharedInstance = !path ? (id)kCFNull : [[<a class="code" href="interface_o_o_database.html">OODatabase</a> alloc] initPath:path] release];
<a name="l00216"></a>00216      <span class="keywordflow">return</span> sharedInstance;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="interface_o_o_database.html#95f96dd15d2f785d919f0096d9c16401">00219</a> + (BOOL)exec:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)fmt, ... {
<a name="l00220"></a>00220     va_list argp; va_start(argp, fmt);
<a name="l00221"></a>00221     NSString *sql = [[[NSString alloc] initWithFormat:fmt arguments:argp] autorelease];
<a name="l00222"></a>00222     va_end( argp );
<a name="l00223"></a>00223     <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#95f96dd15d2f785d919f0096d9c16401">exec</a>:sql];
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">00226</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select intoClass:(Class)recordClass joinFrom:(<span class="keywordtype">id</span>)parent {
<a name="l00227"></a>00227     <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:select <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:recordClass <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:parent];
<a name="l00228"></a>00228 }
<a name="l00229"></a><a class="code" href="interface_o_o_database.html#027faed77babf47df6373b48e6463fb8">00229</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select intoClass:(Class)recordClass {
<a name="l00230"></a>00230     <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:select <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:recordClass <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:nil];
<a name="l00231"></a>00231 }
<a name="l00232"></a><a class="code" href="interface_o_o_database.html#3806fd0d1880bafd3be57faf4c18a100">00232</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select {
<a name="l00233"></a>00233     <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:select <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:nil <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:nil];
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="interface_o_o_database.html#ecd60a49ad0804a927486a8d8af577fe">00236</a> + (int)insertArray:(const <a class="code" href="class_o_o_array.html">OOArray</a>&lt;<span class="keywordtype">id</span>&gt; &amp;)objects { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#ecd60a49ad0804a927486a8d8af577fe">insertArray</a>:objects]; }
<a name="l00237"></a><a class="code" href="interface_o_o_database.html#9f2fa29742bdad99821c6d94bc441e8d">00237</a> + (int)deleteArray:(const <a class="code" href="class_o_o_array.html">OOArray</a>&lt;<span class="keywordtype">id</span>&gt; &amp;)objects { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#9f2fa29742bdad99821c6d94bc441e8d">deleteArray</a>:objects]; }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="interface_o_o_database.html#2b379c2906e1882177b10be7a454d4c9">00239</a> + (int)insert:(<span class="keywordtype">id</span>)object { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#2b379c2906e1882177b10be7a454d4c9">insert</a>:object]; }
<a name="l00240"></a><a class="code" href="interface_o_o_database.html#48acd94d9ec15cd12f18d5a9ce61612b">00240</a> + (int)delete:(<span class="keywordtype">id</span>)object { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#48acd94d9ec15cd12f18d5a9ce61612b">delete</a>:object]; }
<a name="l00241"></a><a class="code" href="interface_o_o_database.html#c0c153636f958053cc6677bad7974eeb">00241</a> + (int)update:(<span class="keywordtype">id</span>)object { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#c0c153636f958053cc6677bad7974eeb">update</a>:object]; }
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="interface_o_o_database.html#7a9d18a556a8f19dd0c18ca35c214a49">00243</a> + (int)indate:(<span class="keywordtype">id</span>)object { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#7a9d18a556a8f19dd0c18ca35c214a49">indate</a>:object]; }
<a name="l00244"></a><a class="code" href="interface_o_o_database.html#f79017a60a9d4057b7a50bb13f7d6517">00244</a> + (int)upsert:(<span class="keywordtype">id</span>)object { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#f79017a60a9d4057b7a50bb13f7d6517">upsert</a>:object]; }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">00246</a> + (int)<a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">commit</a> { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">commit</a>]; }
<a name="l00247"></a><a class="code" href="interface_o_o_database.html#9ed5468dde81867b4daa903ea5249a61">00247</a> + (int)<a class="code" href="interface_o_o_database.html#9ed5468dde81867b4daa903ea5249a61">rollback</a> { <span class="keywordflow">return</span> [[<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#9ed5468dde81867b4daa903ea5249a61">rollback</a>]; }
<a name="l00248"></a><a class="code" href="interface_o_o_database.html#89a802f8ba1136329b7cf4ddf47cf46d">00248</a> + (int)<a class="code" href="interface_o_o_database.html#89a802f8ba1136329b7cf4ddf47cf46d">commitTransaction</a> { <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#89a802f8ba1136329b7cf4ddf47cf46d">commitTransaction</a>]; }
<a name="l00249"></a>00249 <span class="comment"></span>
<a name="l00250"></a>00250 <span class="comment">/**</span>
<a name="l00251"></a>00251 <span class="comment"> Designated initialiser for OODatabase instances. Generally only the shared instance is used</span>
<a name="l00252"></a>00252 <span class="comment"> and the OODatabase class object is messaged instead.</span>
<a name="l00253"></a>00253 <span class="comment"> */</span>
<a name="l00254"></a>00254 
<a name="l00255"></a><a class="code" href="interface_o_o_database.html#476baa688608898428288a7a35c73e47">00255</a> - (<a class="code" href="interface_o_o_database.html">OODatabase</a> *)initPath:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)path {
<a name="l00256"></a>00256     <span class="keywordflow">if</span> ( <span class="keyword">self</span> = [super init] ) {
<a name="l00257"></a>00257         [<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> = [[<a class="code" href="interface_o_o_adaptor.html">OOAdaptor</a> alloc] initPath:path database:self] release];
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 <span class="comment"></span>
<a name="l00262"></a>00262 <span class="comment">/**</span>
<a name="l00263"></a>00263 <span class="comment"> Automatically register all classes which are subclasses of a record abstract superclass (e.g. OORecord).</span>
<a name="l00264"></a>00264 <span class="comment"> */</span>
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="interface_o_o_database.html#1354946630bf58059afb3f00da35f23a">00266</a> - (<a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a>)registerSubclassesOf:(Class)recordSuperClass {
<a name="l00267"></a>00267     <span class="keywordtype">int</span> numClasses = objc_getClassList( NULL, 0 );
<a name="l00268"></a>00268     Class *classes = (Class *)malloc( <span class="keyword">sizeof</span> *classes * numClasses );
<a name="l00269"></a>00269     <a class="code" href="class_o_o_array.html">OOArray&lt;Class&gt;</a> viewClasses;
<a name="l00270"></a>00270     <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> classNames;
<a name="l00271"></a>00271     
<a name="l00272"></a>00272     <span class="comment">// scan all registered classes for relevant subclasses</span>
<a name="l00273"></a>00273     numClasses = objc_getClassList( classes, numClasses );
<a name="l00274"></a>00274     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> c=0 ; c&lt;numClasses ; c++ ) {
<a name="l00275"></a>00275         Class superClass = classes[c];
<a name="l00276"></a>00276         <span class="keywordflow">while</span> ( superClass = class_getSuperclass( superClass ) )
<a name="l00277"></a>00277             <span class="keywordflow">if</span> ( superClass == recordSuperClass ) {
<a name="l00278"></a>00278                 <span class="keywordflow">if</span> ( [classes[c] respondsToSelector:<span class="keyword">@selector</span>(ooTableSql)] )
<a name="l00279"></a>00279                     viewClasses += classes[c];
<a name="l00280"></a>00280                 <span class="keywordflow">else</span> {
<a name="l00281"></a>00281                     [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:classes[c]];
<a name="l00282"></a>00282                     classNames += class_getName( classes[c] );
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284                 <span class="keywordflow">break</span>;
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287     
<a name="l00288"></a>00288     <span class="comment">// delay creation views until after tables</span>
<a name="l00289"></a>00289     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> c=0 ; c&lt;viewClasses ; c++ ) {
<a name="l00290"></a>00290         [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:viewClasses[c]];
<a name="l00291"></a>00291         classNames += class_getName( viewClasses[c] );
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     
<a name="l00294"></a>00294     <span class="comment">// return classes in order registered</span>
<a name="l00295"></a>00295     free( classes );
<a name="l00296"></a>00296     <span class="keywordflow">return</span> classNames;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 <span class="comment"></span>
<a name="l00299"></a>00299 <span class="comment">/**</span>
<a name="l00300"></a>00300 <span class="comment"> Register a list of classes before using them so OODatabase can determine the relationships between them.</span>
<a name="l00301"></a>00301 <span class="comment"> */</span>
<a name="l00302"></a>00302 
<a name="l00303"></a><a class="code" href="interface_o_o_database.html#293a1edbb7ef0510e77b41563e5dd9b3">00303</a> - (void)registerTableClassesNamed:(const <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> &amp;)classes {
<a name="l00304"></a>00304     <span class="keywordflow">for</span> ( NSString *tableClass in *classes )
<a name="l00305"></a>00305         [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[[NSBundle mainBundle] classNamed:tableClass]];
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">/**</span>
<a name="l00309"></a>00309 <span class="comment"> Send any SQL to the database. Sql is a format string so escape any '%' characters using '%%'.</span>
<a name="l00310"></a>00310 <span class="comment"> Any results returned are placed as an array of dictionary values in the database-&gt;results.</span>
<a name="l00311"></a>00311 <span class="comment"> */</span>
<a name="l00312"></a>00312  
<a name="l00313"></a>00313 - (BOOL)exec:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)fmt, ... {
<a name="l00314"></a>00314     va_list argp; va_start(argp, fmt);
<a name="l00315"></a>00315     NSString *sql = [[NSString alloc] initWithFormat:fmt arguments:argp];
<a name="l00316"></a>00316     va_end( argp );
<a name="l00317"></a>00317     <a class="code" href="interface_o_o_database.html#18ccefdb27b9253ad16551f6f85b0e96">results</a> = [<span class="keyword">self</span> select:sql intoClass:NULL joinFrom:nil];
<a name="l00318"></a>00318     [sql release];
<a name="l00319"></a>00319     <span class="keywordflow">return</span> !<a class="code" href="interface_o_o_database.html#fb0242f07f4f610ab8159971fbffb138">errcode</a>;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 <span class="comment"></span>
<a name="l00322"></a>00322 <span class="comment">/**</span>
<a name="l00323"></a>00323 <span class="comment"> Return a single value from row 1, column one from sql sent to the database as a string.</span>
<a name="l00324"></a>00324 <span class="comment"> */</span>
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="interface_o_o_database.html#dc80ea0aa167fd6b8e52bd5c08a36fc1">00326</a> - (<a class="code" href="class_o_o_string.html">OOString</a>)stringForSql:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)fmt, ... {
<a name="l00327"></a>00327     va_list argp; va_start(argp, fmt);
<a name="l00328"></a>00328     NSString *sql = [[[NSString alloc] initWithFormat:fmt arguments:argp] autorelease];
<a name="l00329"></a>00329     va_end( argp );
<a name="l00330"></a>00330     <span class="keywordflow">if</span>( [<span class="keyword">self</span> exec:<span class="stringliteral">"%@"</span>, sql] &amp;&amp; <a class="code" href="interface_o_o_database.html#18ccefdb27b9253ad16551f6f85b0e96">results</a> &gt; 0 ) {
<a name="l00331"></a>00331         NSString *aColumnName = [[**<a class="code" href="interface_o_o_database.html#18ccefdb27b9253ad16551f6f85b0e96">results</a>[0] allKeys] objectAtIndex:0];
<a name="l00332"></a>00332         <span class="keywordflow">return</span> [(*results[0])[aColumnName] stringValue];
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334     <span class="keywordflow">else</span>
<a name="l00335"></a>00335         <span class="keywordflow">return</span> nil;
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 <span class="comment"></span>
<a name="l00338"></a>00338 <span class="comment">/**</span>
<a name="l00339"></a>00339 <span class="comment"> Used to initialise new child records automatically from parent in relation.</span>
<a name="l00340"></a>00340 <span class="comment"> */</span>
<a name="l00341"></a>00341 
<a name="l00342"></a><a class="code" href="interface_o_o_database.html#c2241d1dedefbd157d0e4732551f4183">00342</a> - (id)copyJoinKeysFrom:(<span class="keywordtype">id</span>)parent to:(<span class="keywordtype">id</span>)newChild {
<a name="l00343"></a>00343     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *parentMetaData = [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[parent class]],
<a name="l00344"></a>00344             *childMetaData = [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[newChild class]];
<a name="l00345"></a>00345     <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> commonColumns = [parentMetaData <a class="code" href="interface_o_o_meta_data.html#97144945c8e92caea5043f23bcf6234a">naturalJoinTo</a>:childMetaData-&gt;columns]; <span class="comment">////</span>
<a name="l00346"></a>00346 <span class="comment"></span>    <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> keyValues = [parentMetaData <a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">encode</a>:[parent dictionaryWithValuesForKeys:commonColumns]];
<a name="l00347"></a>00347     [newChild setValuesForKeysWithDictionary:[childMetaData decode:keyValues]];
<a name="l00348"></a>00348     <span class="keywordflow">return</span> newChild;
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 <span class="comment"></span>
<a name="l00351"></a>00351 <span class="comment">/**</span>
<a name="l00352"></a>00352 <span class="comment"> Build a where clause for the columns specified.</span>
<a name="l00353"></a>00353 <span class="comment"> */</span>
<a name="l00354"></a>00354 
<a name="l00355"></a><a class="code" href="interface_o_o_database.html#6d97fa1aca89235a4de5b5bab0e517bc">00355</a> - (<a class="code" href="class_o_o_string.html">OOString</a>)whereClauseFor:(const <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> &amp;)columns values:(const <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt; &amp;)values qualifyNulls:(BOOL)qualifyNulls {
<a name="l00356"></a>00356     <a class="code" href="class_o_o_string.html">OOString</a> out;
<a name="l00357"></a>00357     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;columns ; i++ ) {
<a name="l00358"></a>00358         NSString *name = *columns[i];
<a name="l00359"></a>00359         <span class="keyword">const</span> <span class="keywordtype">char</span> *prefix = i==0 ?<span class="stringliteral">"\nwhere"</span>:<span class="stringliteral">" and"</span>;
<a name="l00360"></a>00360         
<a name="l00361"></a>00361         <span class="keywordtype">id</span> value = values[name];
<a name="l00362"></a>00362         <span class="keywordflow">if</span> ( value == (<span class="keywordtype">id</span>)kCFNull )
<a name="l00363"></a>00363             out += qualifyNulls ? OOFormat( <span class="stringliteral">@"%s\n\t%@ is NULL"</span>, prefix, name ) : <span class="stringliteral">@""</span>;
<a name="l00364"></a>00364         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !qualifyNulls &amp;&amp; [value isKindOfClass:[NSString <span class="keyword">class</span>]] &amp;&amp; [value rangeOfString:<span class="stringliteral">@"%"</span>].location != NSNotFound )
<a name="l00365"></a>00365             out += OOFormat( <span class="stringliteral">@"%s\n\t%@ LIKE ?"</span>, prefix, name );
<a name="l00366"></a>00366         <span class="keywordflow">else</span>
<a name="l00367"></a>00367             out += OOFormat( <span class="stringliteral">@"%s\n\t%@ = ?"</span>, prefix, name );
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369     <span class="keywordflow">return</span> out;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 <span class="comment"></span>
<a name="l00372"></a>00372 <span class="comment">/**</span>
<a name="l00373"></a>00373 <span class="comment"> Prepare the sql passed in adding a where clause with bindings for a join to values taken from the parent record.</span>
<a name="l00374"></a>00374 <span class="comment"> */</span>
<a name="l00375"></a>00375 
<a name="l00376"></a><a class="code" href="interface_o_o_database.html#b1c17aad5e21a6451f6cc0188529247d">00376</a> - (BOOL)prepareSql:(<a class="code" href="class_o_o_string.html">OOString</a> &amp;)sql joinFrom:(<span class="keywordtype">id</span>)parent toTable:(<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *)metaData {
<a name="l00377"></a>00377     <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> joinValues;
<a name="l00378"></a>00378     <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> sharedColumns;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span> ( parent ) {
<a name="l00381"></a>00381         <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *parentMetaData = [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[parent class]];
<a name="l00382"></a>00382         sharedColumns = [parentMetaData <a class="code" href="interface_o_o_meta_data.html#97144945c8e92caea5043f23bcf6234a">naturalJoinTo</a>:metaData-&gt;joinableColumns];
<a name="l00383"></a>00383         joinValues = [parentMetaData <a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">encode</a>:[parent dictionaryWithValuesForKeys:sharedColumns]];
<a name="l00384"></a>00384     
<a name="l00385"></a>00385         sql += [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#6d97fa1aca89235a4de5b5bab0e517bc">whereClauseFor</a>:sharedColumns <a class="code" href="interface_o_o_database.html#6d97fa1aca89235a4de5b5bab0e517bc">values</a>:joinValues <a class="code" href="interface_o_o_database.html#6d97fa1aca89235a4de5b5bab0e517bc">qualifyNulls</a>:NO];
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="keywordflow">if</span> ( [metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> respondsToSelector:<span class="keyword">@selector</span>(ooOrderBy)] )
<a name="l00389"></a>00389         sql += OOFormat( <span class="stringliteral">@"\norder by %@"</span>, [metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> ooOrderBy] );
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="preprocessor">#ifdef OODEBUG_SQL</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>    NSLog( <span class="stringliteral">@"prepareSql: %@\n%@"</span>, *sql, *joinValues );
<a name="l00393"></a>00393 <span class="preprocessor">#endif</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>
<a name="l00395"></a>00395     <span class="keywordflow">if</span> ( ![*<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> prepare:sql] )
<a name="l00396"></a>00396         <span class="keywordflow">return</span> NO;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     <span class="keywordflow">return</span> !parent || [*<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> bindCols:sharedColumns values:joinValues startingAt:1 bindNulls:NO];
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 <span class="comment"></span>
<a name="l00401"></a>00401 <span class="comment">/**</span>
<a name="l00402"></a>00402 <span class="comment"> Determine a list of the tables which have a natural join to the record passed in.</span>
<a name="l00403"></a>00403 <span class="comment"> If the record is a specific instance of from a table this should determine if</span>
<a name="l00404"></a>00404 <span class="comment"> there are any record which exist using the join.</span>
<a name="l00405"></a>00405 <span class="comment"> */</span>
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="interface_o_o_database.html#1b7ae71e5daef8252da2ae3aff0bb7f0">00407</a> - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *&gt;)tablesRelatedByNaturalJoinFrom:(<span class="keywordtype">id</span>)record {
<a name="l00408"></a>00408     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [record class] == [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> class] ? 
<a name="l00409"></a>00409     record : [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[record class]];
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> tablesWithNaturalJoin;
<a name="l00412"></a>00412     tablesWithNaturalJoin &lt;&lt;= metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#4a4f9c0518c5ff1ac3a1f1efb9fe1a91">tablesWithNaturalJoin</a>;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">if</span> ( record &amp;&amp; record != metaData )
<a name="l00415"></a>00415         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;tablesWithNaturalJoin ; i++ ) {
<a name="l00416"></a>00416             <a class="code" href="class_o_o_string.html">OOString</a> sql = OOFormat( <span class="stringliteral">"select count(*) as result from %@"</span>, **tablesWithNaturalJoin[i] );
<a name="l00417"></a>00417             <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *childMetaData = <a class="code" href="interface_o_o_database.html#8f97e74ac08da9c6fa65beabc3949c3f">tableMetaDataByClassName</a>[tablesWithNaturalJoin[i]];
<a name="l00418"></a>00418 
<a name="l00419"></a>00419             [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#b1c17aad5e21a6451f6cc0188529247d">prepareSql</a>:sql <a class="code" href="interface_o_o_database.html#b1c17aad5e21a6451f6cc0188529247d">joinFrom</a>:record <a class="code" href="interface_o_o_database.html#b1c17aad5e21a6451f6cc0188529247d">toTable</a>:childMetaData];
<a name="l00420"></a>00420             <a class="code" href="class_o_o_array.html">OOArray&lt;OODictionary&lt;NSValue *&gt;</a> &gt; tmpResults = [*<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> bindResultsIntoInstancesOfClass:NULL metaData:nil];
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             <span class="keywordflow">if</span> ( ![(*tmpResults[0])[<span class="stringliteral">"result"</span>] intValue] )
<a name="l00423"></a>00423                 ~tablesWithNaturalJoin[i--];
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keywordflow">return</span> <a class="code" href="interface_o_o_database.html#8f97e74ac08da9c6fa65beabc3949c3f">tableMetaDataByClassName</a>[(OOSlice)+tablesWithNaturalJoin];
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 <span class="comment"></span>
<a name="l00429"></a>00429 <span class="comment">/**</span>
<a name="l00430"></a>00430 <span class="comment"> Perform a select from a table on the database using either the sql specified </span>
<a name="l00431"></a>00431 <span class="comment"> orselect all columns from the table associated with the record class passed in.</span>
<a name="l00432"></a>00432 <span class="comment"> If a parent is passed in make a natural join from that record.</span>
<a name="l00433"></a>00433 <span class="comment"> */</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select intoClass:(Class)recordClass joinFrom:(<span class="keywordtype">id</span>)parent {
<a name="l00436"></a>00436     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> tableMetaDataForClass:recordClass ? recordClass : [parent class]];
<a name="l00437"></a>00437     <a class="code" href="class_o_o_string.html">OOString</a> sql = !select ? OOFormat( <span class="stringliteral">@"select %@\nfrom %@"</span>, *(metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#be32e6130bbb23099ca6b4cc6c5c0cd0">outcols</a>/<span class="stringliteral">", "</span>), *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a> ) : *select;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keywordflow">if</span> ( ![<span class="keyword">self</span> prepareSql:sql joinFrom:parent toTable:metaData] )
<a name="l00440"></a>00440         <span class="keywordflow">return</span> nil;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="keywordflow">return</span> [*adaptor bindResultsIntoInstancesOfClass:recordClass metaData:metaData];
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select intoClass:(Class)recordClass {
<a name="l00446"></a>00446     <span class="keywordflow">return</span> [<span class="keyword">self</span> select:select intoClass:recordClass joinFrom:nil];
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)select:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)select {
<a name="l00450"></a>00450     <span class="keywordflow">return</span> [<span class="keyword">self</span> select:select intoClass:nil joinFrom:nil];
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 <span class="comment"></span>
<a name="l00453"></a>00453 <span class="comment">/**</span>
<a name="l00454"></a>00454 <span class="comment"> Returns sqlite3 row identifier for a record instance.</span>
<a name="l00455"></a>00455 <span class="comment"> */</span>
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="interface_o_o_database.html#b03aa85c100f1185c6b194364ce7aa2a">00457</a> - (<span class="keywordtype">long</span> long)rowIDForRecord:(<span class="keywordtype">id</span>)record {
<a name="l00458"></a>00458     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">tableMetaDataForClass</a>:[record class]];
<a name="l00459"></a>00459     <a class="code" href="class_o_o_string.html">OOString</a> sql = OOFormat( <span class="stringliteral">"select ROWID from %@"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a> );
<a name="l00460"></a>00460     <a class="code" href="class_o_o_array.html">OOArray&lt;OODictionary&lt;NSNumber *&gt;</a> &gt; idResults = [<span class="keyword">self</span> <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">select</a>:sql <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">intoClass</a>:nil <a class="code" href="interface_o_o_database.html#1b44fc4a46c7a9b5f8e908ffde136ccf">joinFrom</a>:record];
<a name="l00461"></a>00461     <span class="keywordflow">return</span> [*(*idResults[0])[@"rowid"] longLongValue];
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 <span class="comment"></span>
<a name="l00464"></a>00464 <span class="comment">/**</span>
<a name="l00465"></a>00465 <span class="comment"> Returns sqlite3 row identifier for last inserted record.</span>
<a name="l00466"></a>00466 <span class="comment"> */</span>
<a name="l00467"></a>00467 
<a name="l00468"></a><a class="code" href="interface_o_o_database.html#2d77d6d80274ecdb885a52bdda1b86d7">00468</a> - (<span class="keywordtype">long</span> long)<a class="code" href="interface_o_o_database.html#2d77d6d80274ecdb885a52bdda1b86d7">lastInsertRowID</a> {
<a name="l00469"></a>00469     <span class="keywordflow">return</span> [*<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> lastInsertRowID];
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 <span class="comment"></span>
<a name="l00472"></a>00472 <span class="comment">/**</span>
<a name="l00473"></a>00473 <span class="comment"> Insert an array of record objects into the database. This needs to be commited to take effect.</span>
<a name="l00474"></a>00474 <span class="comment"> */</span>
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 - (int)insertArray:(const <a class="code" href="class_o_o_array.html">OOArray</a>&lt;<span class="keywordtype">id</span>&gt; &amp;)objects {
<a name="l00477"></a>00477     <span class="keywordtype">int</span> count = 0;
<a name="l00478"></a>00478     <span class="keywordflow">for</span> ( <span class="keywordtype">id</span> <span class="keywordtype">object</span> in *objects )
<a name="l00479"></a>00479         count = [<span class="keyword">self</span> insert:object];
<a name="l00480"></a>00480     <span class="keywordflow">return</span> count;
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 <span class="comment"></span>
<a name="l00483"></a>00483 <span class="comment">/**</span>
<a name="l00484"></a>00484 <span class="comment"> Delete an array of record objects from the database. This needs to be commited to take effect.</span>
<a name="l00485"></a>00485 <span class="comment"> */</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 - (int)deleteArray:(const <a class="code" href="class_o_o_array.html">OOArray</a>&lt;<span class="keywordtype">id</span>&gt; &amp;)objects {
<a name="l00488"></a>00488     <span class="keywordtype">int</span> count = 0;
<a name="l00489"></a>00489     <span class="keywordflow">for</span> ( <span class="keywordtype">id</span> <span class="keywordtype">object</span> in *objects )
<a name="l00490"></a>00490         <span class="keywordflow">if</span> ( ![<span class="keywordtype">object</span> respondsToSelector:<span class="keyword">@selector</span>(<span class="keyword">delete</span>)] )
<a name="l00491"></a>00491             count = [<span class="keyword">self</span> delete:object];
<a name="l00492"></a>00492         <span class="keywordflow">else</span> {
<a name="l00493"></a>00493             [object delete];
<a name="l00494"></a>00494             count++;
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496     <span class="keywordflow">return</span> count;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 <span class="comment"></span>
<a name="l00499"></a>00499 <span class="comment">/**</span>
<a name="l00500"></a>00500 <span class="comment"> Insert the values of the record class instance at the time this method was called into the db.</span>
<a name="l00501"></a>00501 <span class="comment"> (must be commited to take effect). Returns the total number of outstanding inserts/updates/deletes.</span>
<a name="l00502"></a>00502 <span class="comment"> */</span>
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 - (int)insert:(<span class="keywordtype">id</span>)record {
<a name="l00505"></a>00505     <span class="keywordflow">return</span> <a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a> += <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt;( <span class="stringliteral">@"__OOOBJECT__"</span>, record, <span class="stringliteral">@"__ISINSERT__"</span>, kCFNull, nil );
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 <span class="comment"></span>
<a name="l00508"></a>00508 <span class="comment">/**</span>
<a name="l00509"></a>00509 <span class="comment"> Use the values of the record instance at the time this method is called in a where clause to </span>
<a name="l00510"></a>00510 <span class="comment"> delete from the database when commit is called. Returns the total number of outstanding</span>
<a name="l00511"></a>00511 <span class="comment"> inserts/updates/deletes.</span>
<a name="l00512"></a>00512 <span class="comment"> */</span>
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 - (int)delete:(<span class="keywordtype">id</span>)record {
<a name="l00515"></a>00515     <span class="keywordflow">return</span> <a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a> += <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt;( <span class="stringliteral">@"__OOOBJECT__"</span>, record, nil );
<a name="l00516"></a>00516 }
<a name="l00517"></a>00517 <span class="comment"></span>
<a name="l00518"></a>00518 <span class="comment">/**</span>
<a name="l00519"></a>00519 <span class="comment"> Call this method if you intend to make changes to the record object and save them to the database.</span>
<a name="l00520"></a>00520 <span class="comment"> This takes a snapshot of the previous values to use as a key for the update operation when "commit"</span>
<a name="l00521"></a>00521 <span class="comment"> is called. Returns the total number of outstanding inserts/updates/deletes.</span>
<a name="l00522"></a>00522 <span class="comment"> */</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 - (int)update:(<span class="keywordtype">id</span>)record {
<a name="l00525"></a>00525     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> tableMetaDataForClass:[record class]];
<a name="l00526"></a>00526     <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> oldValues = [metaData <a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">encode</a>:[record dictionaryWithValuesForKeys:metaData-&gt;columns]];
<a name="l00527"></a>00527     <span class="keywordflow">for</span> ( NSString *key in *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#c4b56f2f76dd7b290b12d0472cc1b4df">tocopy</a> )
<a name="l00528"></a>00528         [oldValues[key] = [oldValues[key] copy] release];
<a name="l00529"></a>00529     oldValues[@"__ISUPDATE__"] = (id)kCFNull;
<a name="l00530"></a>00530     oldValues[@"__OOOBJECT__"] = record;
<a name="l00531"></a>00531     <span class="keywordflow">return</span> <a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a> += oldValues;
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 <span class="comment"></span>
<a name="l00534"></a>00534 <span class="comment">/**</span>
<a name="l00535"></a>00535 <span class="comment"> Inserts a record into the database the deletes any previous record with the same key.</span>
<a name="l00536"></a>00536 <span class="comment"> This ensures the record's rowid changes if this is used by child records.</span>
<a name="l00537"></a>00537 <span class="comment"> */</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 - (int)indate:(<span class="keywordtype">id</span>)record {
<a name="l00540"></a>00540     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> tableMetaDataForClass:[record class]];
<a name="l00541"></a>00541     <a class="code" href="class_o_o_string.html">OOString</a> sql = OOFormat( <span class="stringliteral">"select rowid from %@"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a> );
<a name="l00542"></a>00542     <a class="code" href="class_o_o_array.html">OOArray&lt;id&gt;</a> existing = [<span class="keyword">self</span> select:sql intoClass:nil joinFrom:record];
<a name="l00543"></a>00543     <span class="keywordtype">int</span> count = [<span class="keyword">self</span> insert:record];
<a name="l00544"></a>00544     <span class="keywordflow">for</span> ( NSDictionary *exist in *existing ) {
<a name="l00545"></a>00545         <a class="code" href="class_o_o_string.html">OOString</a> sql = OOFormat( <span class="stringliteral">@"delete from %@ where rowid = %ld"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a>, 
<a name="l00546"></a>00546                                 [[exist objectForKey:<span class="stringliteral">@"rowid"</span>] longLongValue] );
<a name="l00547"></a>00547         <a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a> += <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt;( <span class="stringliteral">@"__OOEXEC__"</span>, *sql, nil );
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549     <span class="keywordflow">return</span> count;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 <span class="comment"></span>
<a name="l00552"></a>00552 <span class="comment">/**</span>
<a name="l00553"></a>00553 <span class="comment"> Inserts a record into the database unless another record with the same key column values</span>
<a name="l00554"></a>00554 <span class="comment"> exists in which case it will do an update of the previous record (preserving the ROWID.)</span>
<a name="l00555"></a>00555 <span class="comment"> */</span>
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 - (int)upsert:(<span class="keywordtype">id</span>)record {
<a name="l00558"></a>00558     <a class="code" href="class_o_o_array.html">OOArray&lt;id&gt;</a> existing = [<span class="keyword">self</span> select:nil intoClass:[record class] joinFrom:record];
<a name="l00559"></a>00559     <span class="keywordflow">if</span> ( existing &gt; 1 )
<a name="l00560"></a>00560         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"upsert: Duplicate record for upsert: @%"</span>, record );
<a name="l00561"></a>00561     <span class="keywordflow">if</span> ( existing &gt; 0 ) {
<a name="l00562"></a>00562         [<span class="keyword">self</span> update:existing[0]];
<a name="l00563"></a>00563         (*<a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a>[-1])[<span class="stringliteral">@"__OOOBJECT__"</span>] = record;
<a name="l00564"></a>00564         <span class="keywordflow">return</span> <a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a>;
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     <span class="keywordflow">else</span>
<a name="l00567"></a>00567         <span class="keywordflow">return</span> [<span class="keyword">self</span> insert:record];
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 <span class="comment"></span>
<a name="l00570"></a>00570 <span class="comment">/**</span>
<a name="l00571"></a>00571 <span class="comment"> Commit all pending inserts, updates and deletes to the database. Use commitTransactin to perform </span>
<a name="l00572"></a>00572 <span class="comment"> this inside a database transaction.</span>
<a name="l00573"></a>00573 <span class="comment"> */</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 - (int)<a class="code" href="interface_o_o_database.html#b3b0c394c385936289fd72317191fa5a">commit</a> {
<a name="l00576"></a>00576     <span class="keywordtype">int</span> commited = 0;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="interface_o_o_database.html#6f417405d0848b4a72d521eb4b5c2780">transaction</a> ; i++ ) {
<a name="l00579"></a>00579         <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> values = transaction[i];
<a name="l00580"></a>00580         <a class="code" href="class_o_o_string.html">OOString</a> exec = (NSMutableString *)~values[<span class="stringliteral">@"__OOEXEC__"</span>];
<a name="l00581"></a>00581         <span class="keywordflow">if</span> ( !!exec ) {
<a name="l00582"></a>00582             <span class="keywordflow">if</span> ( ![<span class="keyword">self</span> exec:<span class="stringliteral">@"%@"</span>, *exec] )
<a name="l00583"></a>00583                 <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"commit: Error in transaction exec: %@ - %s"</span>, *exec, <a class="code" href="interface_o_o_database.html#72808559535f66622cc84431b9490637">errmsg</a> );
<a name="l00584"></a>00584             <span class="keywordflow">continue</span>;
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         OORef&lt;NSObject *&gt; <span class="keywordtype">object</span> = *values[@"__OOOBJECT__"]; values -= <span class="stringliteral">@"__OOOBJECT__"</span>;
<a name="l00588"></a>00588         BOOL isInsert = !!~values[@"__ISINSERT__"], isUpdate = !!~values[@"__ISUPDATE__"];
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> tableMetaDataForClass:[*object class]];
<a name="l00591"></a>00591         <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> newValues = [metaData <a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">encode</a>:[*object dictionaryWithValuesForKeys:metaData-&gt;columns]];
<a name="l00592"></a>00592         <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> changedCols;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         <span class="keywordflow">if</span> ( isUpdate ) {
<a name="l00595"></a>00595             <span class="keywordflow">for</span> ( NSString *name in *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#4bd6dea5fe192c788fb93c766b19806a">columns</a> )
<a name="l00596"></a>00596                 <span class="keywordflow">if</span> ( ![*newValues[name] isEqual:values[name]] )
<a name="l00597"></a>00597                     changedCols += name;
<a name="l00598"></a>00598         }
<a name="l00599"></a>00599         <span class="keywordflow">else</span> 
<a name="l00600"></a>00600             values = newValues;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <a class="code" href="class_o_o_string.html">OOString</a> sql = isInsert ? 
<a name="l00603"></a>00603         OOFormat( <span class="stringliteral">@"insert into %@ (%@) values ("</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a>, *(metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#4bd6dea5fe192c788fb93c766b19806a">columns</a>/<span class="stringliteral">", "</span>) ) :
<a name="l00604"></a>00604         OOFormat( isUpdate ? <span class="stringliteral">@"update %@ set"</span> : <span class="stringliteral">@"delete from %@"</span>, *metaData-&gt;tableName );
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         <span class="keywordtype">int</span> nchanged = changedCols;
<a name="l00607"></a>00607         <span class="keywordflow">if</span> ( isUpdate &amp;&amp; nchanged == 0 ) {
<a name="l00608"></a>00608             <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"%s %@"</span>, <a class="code" href="interface_o_o_database.html#72808559535f66622cc84431b9490637">errmsg</a> = (<span class="keywordtype">char</span> *)<span class="stringliteral">"commit: Update of unchanged record"</span>, *<span class="keywordtype">object</span>, *(<a class="code" href="interface_o_o_database.html#cac90a24aeabafee9f7bebbb12e6ec6e">lastSQL</a> = sql) );
<a name="l00609"></a>00609             <span class="keywordflow">continue</span>;
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611         
<a name="l00612"></a>00612         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;nchanged ; i++ )
<a name="l00613"></a>00613             sql += OOFormat( <span class="stringliteral">@"%s\n\t%@ = ?"</span>, i==0 ? "" : ",", **changedCols[i] );
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         <span class="keywordflow">if</span> ( isInsert ) {
<a name="l00616"></a>00616             <a class="code" href="class_o_o_string.html">OOString</a> quote = <span class="stringliteral">"?"</span>, commaQuote = <span class="stringliteral">", ?"</span>;
<a name="l00617"></a>00617             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#4bd6dea5fe192c788fb93c766b19806a">columns</a> ; i++ )
<a name="l00618"></a>00618                 sql += i==0 ? quote : commaQuote;
<a name="l00619"></a>00619             sql += ")";
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621         <span class="keywordflow">else</span>
<a name="l00622"></a>00622             sql += [self whereClauseFor:metaData-&gt;columns values:values qualifyNulls:YES];
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="preprocessor">#ifdef OODEBUG_SQL</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>        NSLog( <span class="stringliteral">@"commiting: %@ %@"</span>, *sql, *values );
<a name="l00626"></a>00626 <span class="preprocessor">#endif</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>
<a name="l00628"></a>00628         <span class="keywordflow">if</span> ( ![*<a class="code" href="interface_o_o_database.html#c7fe14f4a08314ff4ed7de5d8e923e31">adaptor</a> prepare:sql] )
<a name="l00629"></a>00629             <span class="keywordflow">continue</span>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <span class="keywordflow">if</span> ( isUpdate )
<a name="l00632"></a>00632             [*adaptor bindCols:changedCols values:newValues startingAt:1 bindNulls:YES];
<a name="l00633"></a>00633         [*adaptor bindCols:metaData-&gt;columns values:values startingAt:1+nchanged bindNulls:isInsert];
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         [*adaptor bindResultsIntoInstancesOfClass:nil metaData:metaData];
<a name="l00636"></a>00636         commited += <a class="code" href="interface_o_o_database.html#709b42de98a765ce4b6e5c23c787673f">updateCount</a>;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     transaction = nil;
<a name="l00640"></a>00640     <span class="keywordflow">return</span> commited;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 <span class="comment"></span>
<a name="l00643"></a>00643 <span class="comment">/**</span>
<a name="l00644"></a>00644 <span class="comment"> Commit all pending inserts, updates, deletes to the database inside a transaction.</span>
<a name="l00645"></a>00645 <span class="comment"> */</span>
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 - (int)<a class="code" href="interface_o_o_database.html#89a802f8ba1136329b7cf4ddf47cf46d">commitTransaction</a> {
<a name="l00648"></a>00648     [<span class="keyword">self</span> exec:"BEGIN TRANSACTION"];
<a name="l00649"></a>00649     <span class="keywordtype">int</span> updated = [<span class="keyword">self</span> commit];
<a name="l00650"></a>00650     <span class="keywordflow">return</span> [<span class="keyword">self</span> exec:"COMMIT"] ? updated : 0;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 <span class="comment"></span>
<a name="l00653"></a>00653 <span class="comment">/**</span>
<a name="l00654"></a>00654 <span class="comment"> Rollback any outstanding inserts, updates, or deletes. Please note updated values </span>
<a name="l00655"></a>00655 <span class="comment"> are also rolled back inside the actual record in the application as well.</span>
<a name="l00656"></a>00656 <span class="comment"> */</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 - (int)<a class="code" href="interface_o_o_database.html#9ed5468dde81867b4daa903ea5249a61">rollback</a> {
<a name="l00659"></a>00659     <span class="keywordflow">for</span> ( NSMutableDictionary *d in *transaction ) {
<a name="l00660"></a>00660         <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;id&gt;</a> values = d;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="keywordflow">if</span> ( !!~values[<span class="stringliteral">@"__ISUPDATE__"</span>] ) {
<a name="l00663"></a>00663             OORef&lt;OORecord *&gt; record = ~values[@"__OOOBJECT__"];
<a name="l00664"></a>00664             <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = [<span class="keyword">self</span> tableMetaDataForClass:[*record class]];
<a name="l00665"></a>00665         
<a name="l00666"></a>00666             <span class="keywordflow">for</span> ( NSString *name in *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#cfb30fa38a13d7398b534ab1f783e9a0">boxed</a> )
<a name="l00667"></a>00667                 [(id)[[*record valueForKey:name] pointerValue] release];
<a name="l00668"></a>00668 
<a name="l00669"></a>00669             [*record setValuesForKeysWithDictionary:[metaData <a class="code" href="interface_o_o_meta_data.html#0ab090999c84bdcfb8985b243117df5a">decode</a>:values]];
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     <span class="keywordflow">return</span> [*~transaction count];
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 <span class="comment"></span>
<a name="l00675"></a>00675 <span class="comment">/**</span>
<a name="l00676"></a>00676 <span class="comment"> Find/create an instance of the OOMetaData class which describes a record class and its associated table.</span>
<a name="l00677"></a>00677 <span class="comment"> If the table does not exist it will be created along with indexes for columns/ivars which have </span>
<a name="l00678"></a>00678 <span class="comment"> upper case names for use in joins. Details of the tables parameters can be controlled by using</span>
<a name="l00679"></a>00679 <span class="comment"> methods in the OOTableCustomisation protool. If it does not exist a meta table class which</span>
<a name="l00680"></a>00680 <span class="comment"> prepresents OOMetaData records themselves is also created from which the list of all registered</span>
<a name="l00681"></a>00681 <span class="comment"> tables can be selected.</span>
<a name="l00682"></a>00682 <span class="comment"> */</span>
<a name="l00683"></a>00683  
<a name="l00684"></a><a class="code" href="interface_o_o_database.html#c4173fc74dcf43b558b13688128c7594">00684</a> - (<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *)tableMetaDataForClass:(Class)recordClass {
<a name="l00685"></a>00685     <span class="keywordflow">if</span> ( !recordClass || recordClass == [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <span class="keyword">class</span>] )
<a name="l00686"></a>00686         <span class="keywordflow">return</span> [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#0012b40d1d8a15794dcf30d1e9fcd175">metaDataForClass</a>:[<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> class]];
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     NSString *className = NSStringFromClass( recordClass );
<a name="l00689"></a>00689     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = <a class="code" href="interface_o_o_database.html#8f97e74ac08da9c6fa65beabc3949c3f">tableMetaDataByClassName</a>[className];
<a name="l00690"></a>00690     
<a name="l00691"></a>00691     <span class="keywordflow">if</span> ( !metaData ) {
<a name="l00692"></a>00692         metaData = [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <a class="code" href="interface_o_o_meta_data.html#0012b40d1d8a15794dcf30d1e9fcd175">metaDataForClass</a>:recordClass];
<a name="l00693"></a>00693         
<a name="l00694"></a>00694 <span class="preprocessor">#ifdef OODEBUG_SQL</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>        NSLog(<span class="stringliteral">@"\n%@"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#015c6d8d5ef30f418d1c97ea07be646d">createTableSQL</a>);
<a name="l00696"></a>00696 <span class="preprocessor">#endif</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>        
<a name="l00698"></a>00698         <span class="keywordflow">if</span> ( metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a>[0] != <span class="charliteral">'_'</span> &amp;&amp; 
<a name="l00699"></a>00699             [<span class="keyword">self</span> stringForSql:<span class="stringliteral">"select count(*) from sqlite_master where name = '%@'"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a>] == <span class="stringliteral">"0"</span> )
<a name="l00700"></a>00700             <span class="keywordflow">if</span> ( [<span class="keyword">self</span> exec:<span class="stringliteral">"%@"</span>, *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#015c6d8d5ef30f418d1c97ea07be646d">createTableSQL</a>] )
<a name="l00701"></a>00701                 <span class="keywordflow">for</span> ( NSString *idx in *metaData-&gt;<a class="code" href="interface_o_o_meta_data.html#24c162cad65ed95c334e1add1d8c48a5">indexes</a> )
<a name="l00702"></a>00702                     <span class="keywordflow">if</span> ( ![<span class="keyword">self</span> exec:idx] )
<a name="l00703"></a>00703                         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"tableMetaDataForClass: Error creating index: %@"</span>, idx );
<a name="l00704"></a>00704         
<a name="l00705"></a>00705         <a class="code" href="interface_o_o_database.html#8f97e74ac08da9c6fa65beabc3949c3f">tableMetaDataByClassName</a>[className] = metaData;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707     
<a name="l00708"></a>00708     <span class="keywordflow">return</span> metaData;
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="keyword">@end</span>
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="preprocessor">#pragma mark OOAdaptor - implements all access to a particular database </span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>
<a name="l00715"></a>00715 <span class="keyword">@implementation </span><a class="code" href="interface_o_o_adaptor.html">OOAdaptor</a> 
<a name="l00716"></a>00716 <span class="comment"></span>
<a name="l00717"></a>00717 <span class="comment">/**</span>
<a name="l00718"></a>00718 <span class="comment"> Connect to/create sqlite3 database</span>
<a name="l00719"></a>00719 <span class="comment"> */</span>
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="interface_o_o_adaptor.html#ed86d4fb048e04efd76c4c2afcdab994">00721</a> - (<a class="code" href="interface_o_o_adaptor.html">OOAdaptor</a> *)initPath:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)path database:(<a class="code" href="interface_o_o_database.html">OODatabase</a> *)database {
<a name="l00722"></a>00722     <a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a> = database;
<a name="l00723"></a>00723     <span class="keywordflow">if</span> ( (<a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#fb0242f07f4f610ab8159971fbffb138">errcode</a> = sqlite3_open( path, &amp;<a class="code" href="interface_o_o_adaptor.html#80f5a94ee8eab6e8bd7491138c088b98">db</a> )) != SQLITE_OK ) {
<a name="l00724"></a>00724         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"initPath: Error opening database at path: %@"</span>, *path );
<a name="l00725"></a>00725         <span class="keywordflow">return</span> nil;
<a name="l00726"></a>00726     }
<a name="l00727"></a>00727     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 <span class="comment"></span>
<a name="l00730"></a>00730 <span class="comment">/**</span>
<a name="l00731"></a>00731 <span class="comment"> Prepare a sql statement after which values can be bound and results returned.</span>
<a name="l00732"></a>00732 <span class="comment"> */</span>
<a name="l00733"></a>00733 
<a name="l00734"></a><a class="code" href="interface_o_o_adaptor.html#00789e740a7a9c54030312673dc52901">00734</a> - (BOOL)prepare:(const <a class="code" href="class_o_o_string.html">OOString</a> &amp;)sql {
<a name="l00735"></a>00735     <span class="keywordflow">if</span> ( (<a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#fb0242f07f4f610ab8159971fbffb138">errcode</a> = sqlite3_prepare_v2( <a class="code" href="interface_o_o_adaptor.html#80f5a94ee8eab6e8bd7491138c088b98">db</a>, <a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#cac90a24aeabafee9f7bebbb12e6ec6e">lastSQL</a> = sql, -1, &amp;<a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, 0 )) != SQLITE_OK )
<a name="l00736"></a>00736         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>(<span class="stringliteral">@"prepare: Could not prepare sql: %@ - %s"</span>, *<a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#cac90a24aeabafee9f7bebbb12e6ec6e">lastSQL</a>, <a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#72808559535f66622cc84431b9490637">errmsg</a> = (<span class="keywordtype">char</span> *)sqlite3_errmsg( <a class="code" href="interface_o_o_adaptor.html#80f5a94ee8eab6e8bd7491138c088b98">db</a> ) );
<a name="l00737"></a>00737     <span class="keywordflow">return</span> <a class="code" href="interface_o_o_adaptor.html#72d2659c09a2b3b2a8a259af4090e554">owner</a>-&gt;<a class="code" href="interface_o_o_database.html#fb0242f07f4f610ab8159971fbffb138">errcode</a> == SQLITE_OK;
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a><a class="code" href="interface_o_o_adaptor.html#45e9e014e79b5ef9bbdad660514f8d52">00740</a> - (int)bindValue:(<span class="keywordtype">id</span>)value asParameter:(<span class="keywordtype">int</span>)pno {
<a name="l00741"></a>00741 <span class="preprocessor">#ifdef OODEBUG_BIND</span>
<a name="l00742"></a>00742 <span class="preprocessor"></span>    NSLog( <span class="stringliteral">@"bindValue:bindValue: bind parameter #%d as: %@"</span>, pno, value );
<a name="l00743"></a>00743 <span class="preprocessor">#endif</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( !value || value == (<span class="keywordtype">id</span>)kCFNull )
<a name="l00745"></a>00745         <span class="keywordflow">return</span> sqlite3_bind_null( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno );
<a name="l00746"></a>00746 <span class="preprocessor">#if OOSQL_THREAD_SAFE_BUT_USES_MORE_MEMORY</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( [value isKindOfClass:[NSString <span class="keyword">class</span>]] )
<a name="l00748"></a>00748         <span class="keywordflow">return</span> sqlite3_bind_text( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, [value UTF8String], -1, SQLITE_STATIC );
<a name="l00749"></a>00749 <span class="preprocessor">#else</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( [value isKindOfClass:[NSString <span class="keyword">class</span>]] ) {
<a name="l00751"></a>00751         <span class="keywordtype">int</span> len = [value lengthOfBytesUsingEncoding:NSUTF8StringEncoding];
<a name="l00752"></a>00752         <span class="keyword">struct </span>_str_link *str = (<span class="keyword">struct </span>_str_link *)malloc( <span class="keyword">sizeof</span> *str + len );
<a name="l00753"></a>00753         str-&gt;next = <a class="code" href="interface_o_o_adaptor.html#1644ba1a09de66737511ec8c21c73ff1">strs</a>;
<a name="l00754"></a>00754         <a class="code" href="interface_o_o_adaptor.html#1644ba1a09de66737511ec8c21c73ff1">strs</a> = str;
<a name="l00755"></a>00755         [value getCString:str-&gt;str maxLength:len+1 encoding:NSUTF8StringEncoding];
<a name="l00756"></a>00756         <span class="keywordflow">return</span> sqlite3_bind_text( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, str-&gt;str, len, SQLITE_STATIC );
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758 <span class="preprocessor">#endif</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( [value isKindOfClass:[NSData <span class="keyword">class</span>]] )
<a name="l00760"></a>00760         <span class="keywordflow">return</span> sqlite3_bind_blob( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, [value bytes], [value length], SQLITE_STATIC );            
<a name="l00761"></a>00761     
<a name="l00762"></a>00762     <span class="keyword">const</span> <span class="keywordtype">char</span> *type = [value objCType];
<a name="l00763"></a>00763     <span class="keywordflow">if</span> ( type )
<a name="l00764"></a>00764         <span class="keywordflow">switch</span> ( type[0] ) {
<a name="l00765"></a>00765             <span class="keywordflow">case</span> <span class="charliteral">'c'</span>: <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
<a name="l00766"></a>00766             <span class="keywordflow">case</span> <span class="charliteral">'C'</span>: <span class="keywordflow">case</span> <span class="charliteral">'S'</span>: <span class="keywordflow">case</span> <span class="charliteral">'I'</span>: <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
<a name="l00767"></a>00767                 <span class="keywordflow">return</span> sqlite3_bind_int( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, [value intValue] );
<a name="l00768"></a>00768             <span class="keywordflow">case</span> <span class="charliteral">'q'</span>: <span class="keywordflow">case</span> <span class="charliteral">'Q'</span>:
<a name="l00769"></a>00769                 <span class="keywordflow">return</span> sqlite3_bind_int64( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, [value longLongValue] );
<a name="l00770"></a>00770             <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
<a name="l00771"></a>00771                 <span class="keywordflow">return</span> sqlite3_bind_double( <a class="code" href="interface_o_o_adaptor.html#25f999ff19441f3aa0fbf37821c623c9">stmt</a>, pno, [value doubleValue] );
<a name="l00772"></a>00772         }
<a name="l00773"></a>00773     
<a name="l00774"></a>00774     <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"bindValue:bindValue: Undefined type in bind of parameter #%d: %s, value: %@"</span>, pno, type, value );
<a name="l00775"></a>00775     <span class="keywordflow">return</span> -1;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 <span class="comment"></span>
<a name="l00778"></a>00778 <span class="comment">/**</span>
<a name="l00779"></a>00779 <span class="comment"> Bind parameters from a prepared SQL statement. The "objCType" method is used to determine the type to bind.</span>
<a name="l00780"></a>00780 <span class="comment"> */</span>
<a name="l00781"></a>00781 
<a name="l00782"></a><a class="code" href="interface_o_o_adaptor.html#c2ce207c79b8b3aab10bc92fba616c97">00782</a> - (BOOL)bindCols:(const <a class="code" href="objcpp_8h.html#a71d43d536418b90e3a25dec625c8c24">OOStringArray</a> &amp;)columns values:(const <a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt; &amp;)values startingAt:(<span class="keywordtype">int</span>)pno bindNulls:(BOOL)bindNulls {
<a name="l00783"></a>00783     <span class="keywordtype">int</span> errcode;
<a name="l00784"></a>00784     <span class="keywordflow">for</span> ( NSString *name in *columns )
<a name="l00785"></a>00785         <span class="keywordflow">if</span> ( bindNulls || *values[name] != (<span class="keywordtype">id</span>)kCFNull )
<a name="l00786"></a>00786             <span class="keywordflow">if</span> ( (errcode = [<span class="keyword">self</span> bindValue:values[name] asParameter:pno++]) != SQLITE_OK )
<a name="l00787"></a>00787                 <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"bindCols:... Bind failed column: %@ - %s"</span>, name, owner-&gt;errmsg = (<span class="keywordtype">char</span> *)sqlite3_errmsg( db ), owner-&gt;errcode = errcode );
<a name="l00788"></a>00788     <span class="keywordflow">return</span> owner-&gt;errcode == SQLITE_OK;
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 <span class="comment"></span>
<a name="l00791"></a>00791 <span class="comment">/**</span>
<a name="l00792"></a>00792 <span class="comment"> Return a dictionary containing the values for a row returned by the database from a select.</span>
<a name="l00793"></a>00793 <span class="comment"> These values need to be decoded using a classes metadata to set the ivar values later.</span>
<a name="l00794"></a>00794 <span class="comment"> */</span>
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="interface_o_o_adaptor.html#fcc4fe0b7d7b283a38222bf3f5600b6c">00796</a> - (<a class="code" href="class_o_o_dictionary.html">OODictionary</a>&lt;NSValue *&gt;)valuesForNextRow {
<a name="l00797"></a>00797     <span class="keywordtype">int</span> ncols = sqlite3_column_count( stmt );
<a name="l00798"></a>00798     <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> values;
<a name="l00799"></a>00799     
<a name="l00800"></a>00800     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0 ; i&lt;ncols ; i++ ) {
<a name="l00801"></a>00801         <a class="code" href="class_o_o_string.html">OOString</a> name = sqlite3_column_name( stmt, i );
<a name="l00802"></a>00802         <span class="keywordtype">id</span> value = nil;
<a name="l00803"></a>00803         
<a name="l00804"></a>00804         <span class="keywordflow">switch</span> ( sqlite3_column_type( stmt, i ) ) {
<a name="l00805"></a>00805             <span class="keywordflow">case</span> SQLITE_NULL:
<a name="l00806"></a>00806                 value = (id)kCFNull;
<a name="l00807"></a>00807                 <span class="keywordflow">break</span>;
<a name="l00808"></a>00808             <span class="keywordflow">case</span> SQLITE_INTEGER:
<a name="l00809"></a>00809                 value = [[NSNumber alloc] initWithLongLong:sqlite3_column_int64( stmt, i )]; 
<a name="l00810"></a>00810                 <span class="keywordflow">break</span>;
<a name="l00811"></a>00811             <span class="keywordflow">case</span> SQLITE_FLOAT:
<a name="l00812"></a>00812                 value = [[NSNumber alloc] initWithDouble:sqlite3_column_double( stmt, i )]; 
<a name="l00813"></a>00813                 <span class="keywordflow">break</span>;
<a name="l00814"></a>00814             <span class="keywordflow">case</span> SQLITE_TEXT: {
<a name="l00815"></a>00815                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *bytes = sqlite3_column_text( stmt, i );
<a name="l00816"></a>00816                 value = [[NSMutableString alloc] initWithBytes:bytes
<a name="l00817"></a>00817                                                         length:sqlite3_column_bytes( stmt, i) 
<a name="l00818"></a>00818                                                       encoding:NSUTF8StringEncoding];
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820                 <span class="keywordflow">break</span>;
<a name="l00821"></a>00821             <span class="keywordflow">case</span> SQLITE_BLOB: {
<a name="l00822"></a>00822                 <span class="keyword">const</span> <span class="keywordtype">void</span> *bytes = sqlite3_column_blob( stmt, i );
<a name="l00823"></a>00823                 value = [[NSData alloc] initWithBytes:bytes length:sqlite3_column_bytes( stmt, i )];
<a name="l00824"></a>00824             }
<a name="l00825"></a>00825                 <span class="keywordflow">break</span>;
<a name="l00826"></a>00826             <span class="keywordflow">default</span>:
<a name="l00827"></a>00827                 <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"valuesForNextRow: Invalid type on bind of ivar %@: %d"</span>, *name, sqlite3_column_type( stmt, i ) );
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829         
<a name="l00830"></a>00830         values[name] = value;
<a name="l00831"></a>00831         [value release];
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833     
<a name="l00834"></a>00834     <span class="keywordflow">return</span> values;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 <span class="comment"></span>
<a name="l00837"></a>00837 <span class="comment">/**</span>
<a name="l00838"></a>00838 <span class="comment"> Create instances of the recordClass to store results from a database select or if the record</span>
<a name="l00839"></a>00839 <span class="comment"> class is not present return a list of dictionary objects with the raw results.</span>
<a name="l00840"></a>00840 <span class="comment"> */</span>
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="interface_o_o_adaptor.html#eeaf8fdfb0f7836724e66c0a84e19671">00842</a> - (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)bindResultsIntoInstancesOfClass:(Class)recordClass metaData:(<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *)metaData {
<a name="l00843"></a>00843     <a class="code" href="class_o_o_array.html">OOArray&lt;id&gt;</a> out;
<a name="l00844"></a>00844     BOOL awakeFromDB = [recordClass instancesRespondToSelector:@selector(awakeFromDB)];
<a name="l00845"></a>00845     
<a name="l00846"></a>00846     <span class="keywordflow">while</span>( (owner-&gt;errcode = sqlite3_step( stmt )) == SQLITE_ROW ) {
<a name="l00847"></a>00847         <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;NSValue *&gt;</a> values = [<span class="keyword">self</span> <a class="code" href="interface_o_o_adaptor.html#fcc4fe0b7d7b283a38222bf3f5600b6c">valuesForNextRow</a>];
<a name="l00848"></a>00848         <span class="keywordflow">if</span> ( recordClass ) {
<a name="l00849"></a>00849             <span class="keywordtype">id</span> record = [[recordClass alloc] init];
<a name="l00850"></a>00850             [record setValuesForKeysWithDictionary:[metaData <a class="code" href="interface_o_o_meta_data.html#0ab090999c84bdcfb8985b243117df5a">decode</a>:values]];
<a name="l00851"></a>00851             
<a name="l00852"></a>00852             <span class="keywordflow">if</span> ( awakeFromDB )
<a name="l00853"></a>00853                 [record awakeFromDB];
<a name="l00854"></a>00854             
<a name="l00855"></a>00855             out += record;
<a name="l00856"></a>00856             [record release];
<a name="l00857"></a>00857         }
<a name="l00858"></a>00858         <span class="keywordflow">else</span>
<a name="l00859"></a>00859             out += values;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861     
<a name="l00862"></a>00862     <span class="keywordflow">if</span> ( owner-&gt;errcode != SQLITE_DONE )
<a name="l00863"></a>00863         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>(<span class="stringliteral">@"bindResultsIntoInstancesOfClass:metaData: Not done (bind) stmt: %@ - %s"</span>, *owner-&gt;lastSQL, owner-&gt;errmsg = (<span class="keywordtype">char</span> *)sqlite3_errmsg( db ) );
<a name="l00864"></a>00864     <span class="keywordflow">else</span> {
<a name="l00865"></a>00865         owner-&gt;errcode = SQLITE_OK;
<a name="l00866"></a>00866         out.alloc();
<a name="l00867"></a>00867     }
<a name="l00868"></a>00868     
<a name="l00869"></a>00869     <span class="keywordflow">while</span> ( strs != NULL ) {
<a name="l00870"></a>00870         <span class="keyword">struct </span>_str_link *next = strs-&gt;next;
<a name="l00871"></a>00871         free( strs );
<a name="l00872"></a>00872         strs = next;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874     owner-&gt;updateCount = sqlite3_changes( db );
<a name="l00875"></a>00875     sqlite3_finalize( stmt );
<a name="l00876"></a>00876     <span class="keywordflow">return</span> out;
<a name="l00877"></a>00877 }   
<a name="l00878"></a>00878 
<a name="l00879"></a><a class="code" href="interface_o_o_adaptor.html#dbc6ced1efe6a78b1fc6bffd6e1e45d7">00879</a> - (sqlite_int64)lastInsertRowID {
<a name="l00880"></a>00880     <span class="keywordflow">return</span> sqlite3_last_insert_rowid( db );
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="interface_o_o_adaptor.html#f28958ceac1b784f05172c4958f81fb2">00883</a> - (void) dealloc {
<a name="l00884"></a>00884     sqlite3_close( db );
<a name="l00885"></a>00885     [<span class="keyword">super</span> dealloc];
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="keyword">@end</span>
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 <span class="preprocessor">#pragma mark OOMetaData instances represent a table in the database and it's record class</span>
<a name="l00891"></a>00891 <span class="preprocessor"></span>
<a name="l00892"></a>00892 <span class="keyword">@implementation </span><a class="code" href="interface_o_o_meta_data.html">OOMetaData</a>
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="keyword">static</span> <a class="code" href="class_o_o_dictionary.html">OODictionary&lt;OOMetaData *&gt;</a> metaDataByClass;
<a name="l00895"></a>00895 <span class="keyword">static</span> <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *tableOfTables;
<a name="l00896"></a>00896 
<a name="l00897"></a><a class="code" href="interface_o_o_meta_data.html#e7ed4f0ce10cf0d511d0861b74d68de5">00897</a> + (NSString *)<a class="code" href="interface_o_o_meta_data.html#e7ed4f0ce10cf0d511d0861b74d68de5">ooTableTitle</a> { <span class="keywordflow">return</span> <span class="stringliteral">@"Table MetaData"</span>; }
<a name="l00898"></a>00898 
<a name="l00899"></a><a class="code" href="interface_o_o_meta_data.html#0012b40d1d8a15794dcf30d1e9fcd175">00899</a> + (<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *)metaDataForClass:(Class)recordClass {
<a name="l00900"></a>00900     <span class="keywordflow">if</span> ( !tableOfTables )
<a name="l00901"></a>00901         [tableOfTables = [[<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> alloc] initClass:[<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> class]] release];
<a name="l00902"></a>00902     <a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> *metaData = metaDataByClass[recordClass];
<a name="l00903"></a>00903     <span class="keywordflow">if</span> ( !metaData )
<a name="l00904"></a>00904         [metaData = [[<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> alloc] initClass:recordClass] release];
<a name="l00905"></a>00905     <span class="keywordflow">return</span> metaData;
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00908"></a><a class="code" href="interface_o_o_meta_data.html#2e379f5d16025505ea4de66ab2491fc2">00908</a> + (<a class="code" href="class_o_o_array.html">OOArray</a>&lt;id&gt;)selectRecordsRelatedTo:(<span class="keywordtype">id</span>)record {
<a name="l00909"></a>00909     <span class="keywordflow">return</span> [[<a class="code" href="interface_o_o_database.html">OODatabase</a> <a class="code" href="interface_o_o_database.html#e91cadf4e018098cbc425527581944e6">sharedInstance</a>] <a class="code" href="interface_o_o_database.html#1b7ae71e5daef8252da2ae3aff0bb7f0">tablesRelatedByNaturalJoinFrom</a>:record];
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a><a class="code" href="interface_o_o_meta_data.html#2bb14993913f5c6cbe9a0c2efc422a65">00912</a> - (id)initClass:(Class)aClass {
<a name="l00913"></a>00913     <a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> = aClass;
<a name="l00914"></a>00914     <a class="code" href="interface_o_o_meta_data.html#e82db37db3ca22f45ddc3441eb27cabb">recordClassName</a> = NSStringFromClass(aClass);
<a name="l00915"></a>00915     <a class="code" href="interface_o_o_meta_data.html#c4990ef62a1f6b0fa126a91cda8c3143">tableTitle</a> = [<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> respondsToSelector:@selector(ooTableTitle)] ? [<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> ooTableTitle] : *<a class="code" href="interface_o_o_meta_data.html#e82db37db3ca22f45ddc3441eb27cabb">recordClassName</a>;
<a name="l00916"></a>00916     <a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a> = [<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> respondsToSelector:@selector(ooTableName)] ? [<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> ooTableName] : *<a class="code" href="interface_o_o_meta_data.html#e82db37db3ca22f45ddc3441eb27cabb">recordClassName</a>;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keywordflow">if</span> ( aClass == [<a class="code" href="interface_o_o_meta_data.html">OOMetaData</a> <span class="keyword">class</span>] ) {
<a name="l00919"></a>00919         <a class="code" href="interface_o_o_meta_data.html#09839852ef0397fdd8fb12034d965d79">ivars</a> = <a class="code" href="interface_o_o_meta_data.html#4bd6dea5fe192c788fb93c766b19806a">columns</a> = <a class="code" href="interface_o_o_meta_data.html#be32e6130bbb23099ca6b4cc6c5c0cd0">outcols</a> = <a class="code" href="interface_o_o_meta_data.html#cfb30fa38a13d7398b534ab1f783e9a0">boxed</a> = <a class="code" href="interface_o_o_meta_data.html#aceb89729ced8b2836ec99e4a157b89c">unbox</a> = <span class="stringliteral">"tableTitle tableName recordClassName keyColumns ivars columns outcols"</span>;
<a name="l00920"></a>00920         <span class="keywordflow">return</span> metaDataByClass[recordClass] = <span class="keyword">self</span>;
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <a class="code" href="interface_o_o_meta_data.html#015c6d8d5ef30f418d1c97ea07be646d">createTableSQL</a> = OOFormat( <span class="stringliteral">@"create table %@ ("</span>, *<a class="code" href="interface_o_o_meta_data.html#6edd91e4c32ca630e865cf607d37b1ea">tableName</a> );
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="class_o_o_array.html">OOArray&lt;Class&gt;</a> hierarchy;
<a name="l00926"></a>00926     <span class="keywordflow">do</span>
<a name="l00927"></a>00927         hierarchy += <a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a>;
<a name="l00928"></a>00928     <span class="keywordflow">while</span> ( (<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> = [<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> superclass]) &amp;&amp; <a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> != [NSObject <span class="keyword">class</span>] );
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> h=(<span class="keywordtype">int</span>)hierarchy-1 ; h&gt;=0 ; h-- ) {
<a name="l00931"></a>00931         <a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> = hierarchy[h];
<a name="l00932"></a>00932         
<a name="l00933"></a>00933         Ivar *ivarInfo = class_copyIvarList( <a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a>, NULL );
<a name="l00934"></a>00934         <span class="keywordflow">if</span> ( !ivarInfo )
<a name="l00935"></a>00935             <span class="keywordflow">continue</span>;
<a name="l00936"></a>00936         
<a name="l00937"></a>00937         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> in=0 ; ivarInfo &amp;&amp; ivarInfo[in] ; in++ ) {
<a name="l00938"></a>00938             <a class="code" href="class_o_o_string.html">OOString</a> columnName = (NSMutableString *)[[NSString alloc] initWithUTF8String:ivar_getName( ivarInfo[in] )];
<a name="l00939"></a>00939             [*columnName release];
<a name="l00940"></a>00940             <a class="code" href="interface_o_o_meta_data.html#09839852ef0397fdd8fb12034d965d79">ivars</a> += columnName;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942             <a class="code" href="class_o_o_string.html">OOString</a> type = <a class="code" href="interface_o_o_meta_data.html#4a26991bfff1497fbf9f8ffdd3536e98">types</a>[columnName] = ivar_getTypeEncoding( ivarInfo[in] ), dbtype = <span class="stringliteral">""</span>;
<a name="l00943"></a>00943             
<a name="l00944"></a>00944             <span class="keywordflow">switch</span> ( type[0] ) {
<a name="l00945"></a>00945                 <span class="keywordflow">case</span> <span class="charliteral">'c'</span>: <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
<a name="l00946"></a>00946                 <span class="keywordflow">case</span> <span class="charliteral">'C'</span>: <span class="keywordflow">case</span> <span class="charliteral">'S'</span>: <span class="keywordflow">case</span> <span class="charliteral">'I'</span>: <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
<a name="l00947"></a>00947                 <span class="keywordflow">case</span> <span class="charliteral">'q'</span>: <span class="keywordflow">case</span> <span class="charliteral">'Q'</span>:
<a name="l00948"></a>00948                     dbtype = <span class="stringliteral">@"int"</span>;
<a name="l00949"></a>00949                     <span class="keywordflow">break</span>;
<a name="l00950"></a>00950                 <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
<a name="l00951"></a>00951                     dbtype = <span class="stringliteral">@"real"</span>;
<a name="l00952"></a>00952                     <span class="keywordflow">break</span>;
<a name="l00953"></a>00953                 <span class="keywordflow">case</span> <span class="charliteral">'{'</span>:
<a name="l00954"></a>00954                     <span class="keywordflow">if</span>( !(type &amp; <span class="stringliteral">@"=\"</span>ref\<span class="stringliteral">"@\"NS"</span>) )
<a name="l00955"></a>00955                         <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"initClass: Invalid structure type for ivar %@ in class %@: %@"</span>, *columnName, *<a class="code" href="interface_o_o_meta_data.html#e82db37db3ca22f45ddc3441eb27cabb">recordClassName</a>, *type );
<a name="l00956"></a>00956                     <a class="code" href="interface_o_o_meta_data.html#cfb30fa38a13d7398b534ab1f783e9a0">boxed</a> += columnName;
<a name="l00957"></a>00957                     <span class="keywordflow">if</span> ( ![<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> instancesRespondToSelector:NSSelectorFromString(columnName)] ) {
<a name="l00958"></a>00958                         <a class="code" href="interface_o_o_meta_data.html#aceb89729ced8b2836ec99e4a157b89c">unbox</a> += columnName;
<a name="l00959"></a>00959                         <span class="keywordflow">if</span> ( [[<a class="code" href="interface_o_o_meta_data.html#c2e72138042c2674c81bf50bc6bfe59a">recordClass</a> superclass] instancesRespondToSelector:NSSelectorFromString(columnName)] )
<a name="l00960"></a>00960                             <a class="code" href="objcpp_8h.html#0647b5b82106e1568ba608021c7fc16e">OOWarn</a>( <span class="stringliteral">@"initClass: Superclass of class %@ is providing method for column: %@"</span>, *<a class="code" href="interface_o_o_meta_data.html#e82db37db3ca22f45ddc3441eb27cabb">recordClassName</a>, *columnName );
<a name="l00961"></a>00961                     }
<a name="l00962"></a>00962                 <span class="keywordflow">case</span> <span class="charliteral">'@'</span>:
<a name="l00963"></a>00963                     <span class="keywordflow">if</span> ( type &amp; <span class="stringliteral">@"NS(Mutable)?String\"" )</span>
<a name="l00964"></a>00964 <span class="stringliteral">                        dbtype = @"</span>text<span class="stringliteral">";</span>
<a name="l00965"></a>00965 <span class="stringliteral">                    else if ( type &amp; @"</span>\<span class="stringliteral">"NSDate\""</span> ) {
<a name="l00966"></a>00966                         dbtype = <span class="stringliteral">@"real"</span>;
<a name="l00967"></a>00967                         <a class="code" href="interface_o_o_meta_data.html#d900f22274880f0772b0d9056a5fcadd">dates</a> += columnName;
<a name="l00968"></a>00968                     }
<a name="l00969"></a>00969                     <span class="keywordflow">else</span> {
<a name="l00970"></a>00970                         <span class="keywordflow">if</span> ( !(type &amp; <span class="stringliteral">@"NS(Mutable)?Data\"") )</span>
<a name="l00971"></a>00971 <span class="stringliteral">                            archived += columnName;</span>
<a name="l00972"></a>00972 <span class="stringliteral">                        blobs += columnName;</span>
<a name="l00973"></a>00973 <span class="stringliteral">                        dbtype = @"</span>blob<span class="stringliteral">";</span>
<a name="l00974"></a>00974 <span class="stringliteral">                    }</span>
<a name="l00975"></a>00975 <span class="stringliteral">                    break;</span>
<a name="l00976"></a>00976 <span class="stringliteral">                default:</span>
<a name="l00977"></a>00977 <span class="stringliteral">                    OOWarn( @"</span>initClass: Unknown data type <span class="stringliteral">'%@'</span> in <span class="keyword">class</span> %<span class="stringliteral">@", *type, *tableName );</span>
<a name="l00978"></a>00978 <span class="stringliteral">                    archived += columnName;</span>
<a name="l00979"></a>00979 <span class="stringliteral">                    blobs += columnName;</span>
<a name="l00980"></a>00980 <span class="stringliteral">                    dbtype = @"</span>blob<span class="stringliteral">";</span>
<a name="l00981"></a>00981 <span class="stringliteral">                    break;</span>
<a name="l00982"></a>00982 <span class="stringliteral">            }</span>
<a name="l00983"></a>00983 <span class="stringliteral"></span>
<a name="l00984"></a>00984 <span class="stringliteral">            if ( dbtype == "</span>text<span class="stringliteral">" )</span>
<a name="l00985"></a>00985 <span class="stringliteral">                tocopy += columnName;</span>
<a name="l00986"></a>00986 <span class="stringliteral"></span>
<a name="l00987"></a>00987 <span class="stringliteral">            if ( columnName == "</span>rowid<span class="stringliteral">" || columnName == "</span>ROWID<span class="stringliteral">" || columnName == "</span>OID<span class="stringliteral">" || columnName == "</span>_ROWID_<span class="stringliteral">" ) {</span>
<a name="l00988"></a>00988 <span class="stringliteral">                outcols += columnName;</span>
<a name="l00989"></a>00989 <span class="stringliteral">                continue;</span>
<a name="l00990"></a>00990 <span class="stringliteral">            }</span>
<a name="l00991"></a>00991 <span class="stringliteral"></span>
<a name="l00992"></a>00992 <span class="stringliteral">            createTableSQL += OOFormat(@"</span>%s\n\t%@ %@ <span class="comment">/* %@ */</span><span class="stringliteral">", !columns?"</span><span class="stringliteral">":"</span>,<span class="stringliteral">", *columnName, *dbtype, *type );</span>
<a name="l00993"></a>00993 <span class="stringliteral">            if ( isupper( columnName[0] ) )</span>
<a name="l00994"></a>00994 <span class="stringliteral">                indexes += OOFormat(@"</span>create index %@_%@ on %@ (%@)\n<span class="stringliteral">",</span>
<a name="l00995"></a>00995 <span class="stringliteral">                                    *tableName, *columnName,</span>
<a name="l00996"></a>00996 <span class="stringliteral">                                    *tableName, *columnName);</span>
<a name="l00997"></a>00997 <span class="stringliteral"></span>
<a name="l00998"></a>00998 <span class="stringliteral">            if ( columnName[0] != '_' ) {</span>
<a name="l00999"></a>00999 <span class="stringliteral">                columns += columnName;</span>
<a name="l01000"></a>01000 <span class="stringliteral">                outcols += columnName;</span>
<a name="l01001"></a>01001 <span class="stringliteral">                if ( h==0 )</span>
<a name="l01002"></a>01002 <span class="stringliteral">                    joinableColumns += columnName;          </span>
<a name="l01003"></a>01003 <span class="stringliteral">            }</span>
<a name="l01004"></a>01004 <span class="stringliteral">        }</span>
<a name="l01005"></a>01005 <span class="stringliteral">        </span>
<a name="l01006"></a>01006 <span class="stringliteral">        free( ivarInfo );</span>
<a name="l01007"></a>01007 <span class="stringliteral">    }</span>
<a name="l01008"></a>01008 <span class="stringliteral">    </span>
<a name="l01009"></a>01009 <span class="stringliteral">    if ( [recordClass respondsToSelector:@selector(ooTableKey)] )</span>
<a name="l01010"></a>01010 <span class="stringliteral">        createTableSQL += OOFormat( @"</span>,\n\tprimary key (%@)<span class="stringliteral">", *(keyColumns = [recordClass ooTableKey]) );</span>
<a name="l01011"></a>01011 <span class="stringliteral">    </span>
<a name="l01012"></a>01012 <span class="stringliteral">    if ( [recordClass respondsToSelector:@selector(ooConstraints)] )</span>
<a name="l01013"></a>01013 <span class="stringliteral">        createTableSQL += OOFormat( @"</span>,\n\t%<span class="stringliteral">@", [recordClass ooConstraints] );</span>
<a name="l01014"></a>01014 <span class="stringliteral">    </span>
<a name="l01015"></a>01015 <span class="stringliteral">    createTableSQL += "</span>\n)\n<span class="stringliteral">";</span>
<a name="l01016"></a>01016 <span class="stringliteral">    </span>
<a name="l01017"></a>01017 <span class="stringliteral">    if ( [recordClass respondsToSelector:@selector(ooTableSql)] ) {</span>
<a name="l01018"></a>01018 <span class="stringliteral">        createTableSQL = [recordClass ooTableSql];</span>
<a name="l01019"></a>01019 <span class="stringliteral">        indexes = nil;</span>
<a name="l01020"></a>01020 <span class="stringliteral">    }</span>
<a name="l01021"></a>01021 <span class="stringliteral"></span>
<a name="l01022"></a>01022 <span class="stringliteral">    tableOfTables-&gt;tablesWithNaturalJoin += recordClassName;</span>
<a name="l01023"></a>01023 <span class="stringliteral">    tablesWithNaturalJoin += recordClassName;</span>
<a name="l01024"></a>01024 <span class="stringliteral">    </span>
<a name="l01025"></a>01025 <span class="stringliteral">    for( Class other in [*metaDataByClass allKeys] ) {</span>
<a name="l01026"></a>01026 <span class="stringliteral">        OOMetaData *otherMetaData = metaDataByClass[other];</span>
<a name="l01027"></a>01027 <span class="stringliteral">        if ( otherMetaData == tableOfTables )</span>
<a name="l01028"></a>01028 <span class="stringliteral">            continue;</span>
<a name="l01029"></a>01029 <span class="stringliteral">        </span>
<a name="l01030"></a>01030 <span class="stringliteral">        if ( [self naturalJoinTo:otherMetaData-&gt;joinableColumns] &gt; 0 )</span>
<a name="l01031"></a>01031 <span class="stringliteral">            tablesWithNaturalJoin += otherMetaData-&gt;recordClassName;</span>
<a name="l01032"></a>01032 <span class="stringliteral">        if ( [otherMetaData naturalJoinTo:joinableColumns] &gt; 0 )</span>
<a name="l01033"></a>01033 <span class="stringliteral">            otherMetaData-&gt;tablesWithNaturalJoin += recordClassName;</span>
<a name="l01034"></a>01034 <span class="stringliteral">    }</span>
<a name="l01035"></a>01035 <span class="stringliteral">    </span>
<a name="l01036"></a>01036 <span class="stringliteral">    return metaDataByClass[recordClass] = self;</span>
<a name="l01037"></a>01037 <span class="stringliteral">}</span>
<a name="l01038"></a>01038 <span class="stringliteral"></span><span class="comment"></span>
<a name="l01039"></a>01039 <span class="comment">/**</span>
<a name="l01040"></a>01040 <span class="comment"> Find the columns shared between two classes and that have upper case names (are indexed).</span>
<a name="l01041"></a>01041 <span class="comment"> */</span>
<a name="l01042"></a>01042 
<a name="l01043"></a><a class="code" href="interface_o_o_meta_data.html#97144945c8e92caea5043f23bcf6234a">01043</a> - (OOStringArray)naturalJoinTo:(const OOStringArray &amp;)to {
<a name="l01044"></a>01044     OOStringArray commonColumns = columns &amp; to;
<a name="l01045"></a>01045     for ( int i=0 ; i&lt;commonColumns ; i++ )
<a name="l01046"></a>01046         if ( islower( (*commonColumns[i])[0] ) )
<a name="l01047"></a>01047             ~commonColumns[i--];
<a name="l01048"></a>01048     return commonColumns;
<a name="l01049"></a>01049 }
<a name="l01050"></a>01050 <span class="comment"></span>
<a name="l01051"></a>01051 <span class="comment">/**</span>
<a name="l01052"></a>01052 <span class="comment"> Encode values ready for insertion into the database (convert OOString to NSString etc.)</span>
<a name="l01053"></a>01053 <span class="comment"> */</span>
<a name="l01054"></a>01054 
<a name="l01055"></a><a class="code" href="interface_o_o_meta_data.html#85c626407a76f3841ed95f6a7225735b">01055</a> - (const OODictionary&lt;NSValue *&gt; &amp;)encode:(const OODictionary&lt;NSValue *&gt; &amp;)values {
<a name="l01056"></a>01056     for ( NSString *key in *unbox ) {
<a name="l01057"></a>01057         id value = (id)[*values[key] pointerValue];
<a name="l01058"></a>01058         values[key] = value ? value : (id)kCFNull;
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060     for ( NSString *key in *dates )
<a name="l01061"></a>01061         values[key] = [NSNumber numberWithDouble:[values[key] timeIntervalSince1970]];
<a name="l01062"></a>01062     for ( NSString *key in *archived )
<a name="l01063"></a>01063         values[key] = (NSValue *)[NSKeyedArchiver archivedDataWithRootObject:values[key]];
<a name="l01064"></a>01064     return values;
<a name="l01065"></a>01065 }
<a name="l01066"></a>01066 <span class="comment"></span>
<a name="l01067"></a>01067 <span class="comment">/**</span>
<a name="l01068"></a>01068 <span class="comment"> Decode values taken from the database for use in [record setValuesForKeysWithDictionary:values];</span>
<a name="l01069"></a>01069 <span class="comment"> */</span>
<a name="l01070"></a>01070 
<a name="l01071"></a><a class="code" href="interface_o_o_meta_data.html#0ab090999c84bdcfb8985b243117df5a">01071</a> - (const OODictionary&lt;NSValue *&gt; &amp;)decode:(const OODictionary&lt;NSValue *&gt; &amp;)values {
<a name="l01072"></a>01072     id value;
<a name="l01073"></a>01073     for ( NSString *key in *archived ) 
<a name="l01074"></a>01074         if ( value = values[key] )
<a name="l01075"></a>01075             values[key] = [NSKeyedUnarchiver unarchiveObjectWithData:(NSData *)value];
<a name="l01076"></a>01076     for ( NSString *key in *dates )
<a name="l01077"></a>01077         if ( value = values[key] )
<a name="l01078"></a>01078             values[key] = [NSDate dateWithTimeIntervalSince1970:[value doubleValue]];
<a name="l01079"></a>01079     for ( NSString *key in *boxed ) {
<a name="l01080"></a>01080         if ( value = values[key] ) {
<a name="l01081"></a>01081             value = value != (id)kCFNull ? [value retain] : nil;
<a name="l01082"></a>01082             [values[key] = [[NSValue alloc] initWithBytes:&amp;value objCType:@encode(id)] release];
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085     return values;
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 <span class="comment"></span>
<a name="l01088"></a>01088 <span class="comment">/**</span>
<a name="l01089"></a>01089 <span class="comment"> import values for a list of nodes selected from an XML document.</span>
<a name="l01090"></a>01090 <span class="comment"> */</span>
<a name="l01091"></a>01091 
<a name="l01092"></a><a class="code" href="interface_o_o_meta_data.html#4b9e3a8f2109c79af2018f05c47dd67e">01092</a> + (OOArray&lt;id&gt;)import:(const OOArray&lt;OODictionary&lt;OOString&gt; &gt; &amp;)nodes intoClass:(Class)recordClass {
<a name="l01093"></a>01093     OOMetaData *metaData = [self metaDataForClass:recordClass];
<a name="l01094"></a>01094     OOArray&lt;id&gt; out;
<a name="l01095"></a>01095     
<a name="l01096"></a>01096     for ( NSMutableDictionary *dict in *nodes ) {
<a name="l01097"></a>01097         OODictionary&lt;OOString&gt; node = dict, values;
<a name="l01098"></a>01098         for ( NSString *ivar in *metaData-&gt;columns )
<a name="l01099"></a>01099             values[ivar] = node[ivar];
<a name="l01100"></a>01100         
<a name="l01101"></a>01101         id record = [[recordClass alloc] init];
<a name="l01102"></a>01102         [record setValuesForKeysWithDictionary:[metaData decode:values]];
<a name="l01103"></a>01103         out += record;
<a name="l01104"></a>01104         [record release];
<a name="l01105"></a>01105     }
<a name="l01106"></a>01106     
<a name="l01107"></a>01107     return out;
<a name="l01108"></a>01108 }
<a name="l01109"></a>01109 <span class="comment"></span>
<a name="l01110"></a>01110 <span class="comment">/**</span>
<a name="l01111"></a>01111 <span class="comment"> Convert a string taken from a flat file into record instances which can be inserted into the database.</span>
<a name="l01112"></a>01112 <span class="comment"> */</span>
<a name="l01113"></a>01113 
<a name="l01114"></a><a class="code" href="interface_o_o_meta_data.html#d2369ad36e4b1daf4c967460147958cd">01114</a> + (OOArray&lt;id&gt;)import:(const OOString &amp;)string intoClass:(Class)recordClass delimiter:(const OOString &amp;)delim {
<a name="l01115"></a>01115     OOMetaData *metaData = [self metaDataForClass:recordClass];
<a name="l01116"></a>01116     // remove escaped newlines then split by newline
<a name="l01117"></a>01117     OOStringArray lines = (string - "\\\n<span class="stringliteral">") / "</span>\n<span class="stringliteral">";</span>
<a name="l01118"></a>01118 <span class="stringliteral">    lines--; // pop last empty line</span>
<a name="l01119"></a>01119 <span class="stringliteral">    </span>
<a name="l01120"></a>01120 <span class="stringliteral">    OOArray&lt;id&gt; out;</span>
<a name="l01121"></a>01121 <span class="stringliteral">    for ( int l=0 ; l&lt;lines ; l++ ) {</span>
<a name="l01122"></a>01122 <span class="stringliteral">        OODictionary&lt;NSString *&gt; values;</span>
<a name="l01123"></a>01123 <span class="stringliteral">        values[metaData-&gt;columns] = *lines[l] / delim;</span>
<a name="l01124"></a>01124 <span class="stringliteral">        </span>
<a name="l01125"></a>01125 <span class="stringliteral">        // empty columns are taken as null values</span>
<a name="l01126"></a>01126 <span class="stringliteral">        for ( NSString *key in *metaData-&gt;columns )</span>
<a name="l01127"></a>01127 <span class="stringliteral">            if ( [*values[key] isEqualToString:@"</span><span class="stringliteral">"] )</span>
<a name="l01128"></a>01128 <span class="stringliteral">                values[key] = (id)kCFNull;</span>
<a name="l01129"></a>01129 <span class="stringliteral">        </span>
<a name="l01130"></a>01130 <span class="stringliteral">        // convert description strings to NSData</span>
<a name="l01131"></a>01131 <span class="stringliteral">        for ( NSString *key in *metaData-&gt;blobs )</span>
<a name="l01132"></a>01132 <span class="stringliteral">            [values[key] = [[NSData alloc] initWithDescription:values[key]] release];</span>
<a name="l01133"></a>01133 <span class="stringliteral">        </span>
<a name="l01134"></a>01134 <span class="stringliteral">        id record = [[recordClass alloc] init];</span>
<a name="l01135"></a>01135 <span class="stringliteral">        [record setValuesForKeysWithDictionary:[metaData decode:values]];</span>
<a name="l01136"></a>01136 <span class="stringliteral">        out += record;</span>
<a name="l01137"></a>01137 <span class="stringliteral">        [record release];</span>
<a name="l01138"></a>01138 <span class="stringliteral">    }</span>
<a name="l01139"></a>01139 <span class="stringliteral">    </span>
<a name="l01140"></a>01140 <span class="stringliteral">    return out;</span>
<a name="l01141"></a>01141 <span class="stringliteral">}</span>
<a name="l01142"></a>01142 <span class="stringliteral"></span><span class="comment"></span>
<a name="l01143"></a>01143 <span class="comment">/**</span>
<a name="l01144"></a>01144 <span class="comment"> Convert a set of records selected from the database into a string which can be saved to disk.</span>
<a name="l01145"></a>01145 <span class="comment"> */</span>
<a name="l01146"></a>01146 
<a name="l01147"></a><a class="code" href="interface_o_o_meta_data.html#9b4e09c341e749d159d727447072fa6c">01147</a> + (OOString)export:(const OOArray&lt;id&gt; &amp;)array delimiter:(const OOString &amp;)delim {
<a name="l01148"></a>01148     OOMetaData *metaData = nil;
<a name="l01149"></a>01149     OOString out;
<a name="l01150"></a>01150     
<a name="l01151"></a>01151     for ( id record in *array ) {
<a name="l01152"></a>01152         if ( !metaData )
<a name="l01153"></a>01153             metaData = [record isKindOfClass:[NSDictionary class]] ?
<a name="l01154"></a>01154             (id)kCFNull : [self metaDataForClass:[record class]];
<a name="l01155"></a>01155         
<a name="l01156"></a>01156         OODictionary&lt;NSValue *&gt; values = metaData == (id)kCFNull ? record : 
<a name="l01157"></a>01157         *[metaData encode:[record dictionaryWithValuesForKeys:metaData-&gt;columns]];
<a name="l01158"></a>01158         
<a name="l01159"></a>01159         OOStringArray line;
<a name="l01160"></a>01160         NSString *blank = @"<span class="stringliteral">";</span>
<a name="l01161"></a>01161 <span class="stringliteral">        for ( NSString *key in *metaData-&gt;columns )</span>
<a name="l01162"></a>01162 <span class="stringliteral">            line += *values[key] != (id)kCFNull ? [values[key] stringValue] : blank;</span>
<a name="l01163"></a>01163 <span class="stringliteral">        </span>
<a name="l01164"></a>01164 <span class="stringliteral">        out += line/delim+"</span>\n<span class="stringliteral">";</span>
<a name="l01165"></a>01165 <span class="stringliteral">    }</span>
<a name="l01166"></a>01166 <span class="stringliteral">    </span>
<a name="l01167"></a>01167 <span class="stringliteral">    return out;</span>
<a name="l01168"></a>01168 <span class="stringliteral">}</span>
<a name="l01169"></a>01169 <span class="stringliteral"></span><span class="comment"></span>
<a name="l01170"></a>01170 <span class="comment">/**</span>
<a name="l01171"></a>01171 <span class="comment"> Bind a record to a view containing elements which are to display values from the record.</span>
<a name="l01172"></a>01172 <span class="comment"> The ivar number is selected by the subview's tag value and it's ".text" property if set to</span>
<a name="l01173"></a>01173 <span class="comment"> the value returned record value "stringValue" for the ivar. Supports images stored as</span>
<a name="l01174"></a>01174 <span class="comment"> NSData objects, UISwitches bound to boolean valuea and UITextField for alll other values.</span>
<a name="l01175"></a>01175 <span class="comment"> */</span>
<a name="l01176"></a>01176 
<a name="l01177"></a><a class="code" href="interface_o_o_meta_data.html#7c6e31e9eaaebdb3acbf10e3adda1274">01177</a> + (void)bindRecord:(id)record toView:(UIView *)view delegate:(id)delegate {
<a name="l01178"></a>01178 #ifdef __IPHONE_OS_VERSION_MIN_REQUIRED
<a name="l01179"></a>01179     OOMetaData *metaData = [self metaDataForClass:[record class]];
<a name="l01180"></a>01180     OODictionary&lt;NSValue *&gt; values = [metaData encode:[record dictionaryWithValuesForKeys:metaData-&gt;ivars]];
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     for ( int i=0 ; i&lt;metaData-&gt;ivars ; i++ ) {
<a name="l01183"></a>01183         UILabel *label = (UILabel *)[view viewWithTag:1+i];
<a name="l01184"></a>01184         id value = values[metaData-&gt;ivars[i]];
<a name="l01185"></a>01185         
<a name="l01186"></a>01186         if ( [label isKindOfClass:[UIImageView class]] )
<a name="l01187"></a>01187             ((UIImageView *)label).image = value != (id)kCFNull ? [UIImage imageWithData:(NSData *)value] : nil;
<a name="l01188"></a>01188         else if ( [label isKindOfClass:[UISwitch class]] ) {
<a name="l01189"></a>01189             UISwitch *uiSwitch = (UISwitch *)label;
<a name="l01190"></a>01190             uiSwitch.on = value != (id)kCFNull ? [value charValue] : 0;
<a name="l01191"></a>01191             if ( delegate )
<a name="l01192"></a>01192                 [uiSwitch addTarget:delegate action:@selector(valueChanged:) forControlEvents:UIControlEventValueChanged];
<a name="l01193"></a>01193         }
<a name="l01194"></a>01194         else if ( [label isKindOfClass:[UIWebView class]] )
<a name="l01195"></a>01195             [(UIWebView *)label loadHTMLString:value != (id)kCFNull ? value : @"<span class="stringliteral">" baseURL:nil];</span>
<a name="l01196"></a>01196 <span class="stringliteral">        else if ( label ) {</span>
<a name="l01197"></a>01197 <span class="stringliteral">            label.text = value != (id)kCFNull ? [value stringValue] : @"</span><span class="stringliteral">";</span>
<a name="l01198"></a>01198 <span class="stringliteral">            if ( [label isKindOfClass:[UITextView class]] ) {</span>
<a name="l01199"></a>01199 <span class="stringliteral">                [(UITextView *)label setContentOffset:CGPointMake(0,0) animated:NO];</span>
<a name="l01200"></a>01200 <span class="stringliteral">                [(UITextView *)label scrollRangeToVisible:NSMakeRange(0,0)];</span>
<a name="l01201"></a>01201 <span class="stringliteral">            }</span>
<a name="l01202"></a>01202 <span class="stringliteral">        }</span>
<a name="l01203"></a>01203 <span class="stringliteral">        </span>
<a name="l01204"></a>01204 <span class="stringliteral">        if ( [label respondsToSelector:@selector(delegate)] )</span>
<a name="l01205"></a>01205 <span class="stringliteral">            ((UITextField *)label).delegate = delegate;</span>
<a name="l01206"></a>01206 <span class="stringliteral">        label.hidden = NO;</span>
<a name="l01207"></a>01207 <span class="stringliteral">        </span>
<a name="l01208"></a>01208 <span class="stringliteral">        if ( label = (UILabel *)[view viewWithTag:-1-i] ) {</span>
<a name="l01209"></a>01209 <span class="stringliteral">            label.text = **metaData-&gt;ivars[i];</span>
<a name="l01210"></a>01210 <span class="stringliteral">            label.hidden = NO;</span>
<a name="l01211"></a>01211 <span class="stringliteral">        }</span>
<a name="l01212"></a>01212 <span class="stringliteral">    }</span>
<a name="l01213"></a>01213 <span class="stringliteral">    </span>
<a name="l01214"></a>01214 <span class="stringliteral">    UIView *subView;</span>
<a name="l01215"></a>01215 <span class="stringliteral">    for ( int i=metaData-&gt;ivars ; subView = [view viewWithTag:1+i] ; i++ ) {</span>
<a name="l01216"></a>01216 <span class="stringliteral">        subView.hidden = YES;</span>
<a name="l01217"></a>01217 <span class="stringliteral">        if ( subView = [view viewWithTag:-1-i] )</span>
<a name="l01218"></a>01218 <span class="stringliteral">            subView.hidden =YES;</span>
<a name="l01219"></a>01219 <span class="stringliteral">    }</span>
<a name="l01220"></a>01220 <span class="stringliteral">#endif</span>
<a name="l01221"></a>01221 <span class="stringliteral">}</span>
<a name="l01222"></a>01222 <span class="stringliteral"></span><span class="comment"></span>
<a name="l01223"></a>01223 <span class="comment">/**</span>
<a name="l01224"></a>01224 <span class="comment"> When the delegate method fires this method should be called to update</span>
<a name="l01225"></a>01225 <span class="comment"> the record with the modified value before updating the database.</span>
<a name="l01226"></a>01226 <span class="comment"> */</span>
<a name="l01227"></a>01227 
<a name="l01228"></a><a class="code" href="interface_o_o_meta_data.html#490c4a66a3e7b4838a4d26c29bed80d0">01228</a> + (void)updateRecord:(id)record fromView:(UIView *)view {
<a name="l01229"></a>01229 #ifdef __IPHONE_OS_VERSION_MIN_REQUIRED
<a name="l01230"></a>01230     if ( view.tag &gt; 0 &amp;&amp; [view respondsToSelector:@selector(text)] ) {
<a name="l01231"></a>01231         OOMetaData *metaData = [self metaDataForClass:[record class]];
<a name="l01232"></a>01232         NSString *name = *metaData-&gt;ivars[view.tag-1];
<a name="l01233"></a>01233         OOString type = metaData-&gt;types[name];
<a name="l01234"></a>01234         id value = [((UITextField *)view).text retain];
<a name="l01235"></a>01235         
<a name="l01236"></a>01236         if ( type[0] == '{' ) {
<a name="l01237"></a>01237             value = [[NSValue alloc] initWithBytes:&amp;value objCType:@encode(id)];
<a name="l01238"></a>01238             [(id)[[record valueForKey:name] pointerValue] release];
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240         
<a name="l01241"></a>01241         [record setValue:value forKey:name];
<a name="l01242"></a>01242         [value release];
<a name="l01243"></a>01243     }
<a name="l01244"></a>01244     for ( UIView *subview in [view subviews] )
<a name="l01245"></a>01245         [self updateRecord:record fromView:subview];
<a name="l01246"></a>01246 #endif
<a name="l01247"></a>01247 }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 @end
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 @implementation NSData(OOExtras)
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 static int unhex ( unsigned char ch ) {
<a name="l01254"></a>01254     return ch &gt;= 'a' ? 10 + ch - 'a'  : ch &gt;= 'A' ? 10 + ch - 'A' : ch - '0';
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257 - initWithDescription:(NSString *)description {
<a name="l01258"></a>01258     int len = [description length]/2, lin = [description lengthOfBytesUsingEncoding:NSUTF8StringEncoding];
<a name="l01259"></a>01259     char *bytes = (char *)malloc( len ), *optr = bytes, *hex = (char *)malloc( lin+1 );
<a name="l01260"></a>01260     [description getCString:hex maxLength:lin+1 encoding:NSUTF8StringEncoding];
<a name="l01261"></a>01261 
<a name="l01262"></a>01262     for ( char *iptr = hex ; *iptr ; iptr+=2 ) {
<a name="l01263"></a>01263         if ( *iptr == '&lt;' || *iptr == ' ' || *iptr == '&gt;' )
<a name="l01264"></a>01264             iptr--;
<a name="l01265"></a>01265         else
<a name="l01266"></a>01266             *optr++ = unhex( *iptr )*16 + unhex( *(iptr+1) );
<a name="l01267"></a>01267     }
<a name="l01268"></a>01268     
<a name="l01269"></a>01269     free( hex );
<a name="l01270"></a>01270     return [self initWithBytesNoCopy:bytes length:optr-bytes freeWhenDone:YES];
<a name="l01271"></a>01271 }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 - (NSString *)stringValue { return [self description]; }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 @end
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 @interface NSString(OOExtras)
<a name="l01278"></a>01278 @end
<a name="l01279"></a>01279 @implementation NSString(OOExtras)
<a name="l01280"></a>01280 - (char)charValue { return [self intValue]; }
<a name="l01281"></a>01281 - (char)shortValue { return [self intValue]; }
<a name="l01282"></a>01282 - (NSString *)stringValue { return self; }
<a name="l01283"></a>01283 @end
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 @interface NSArray(OOExtras)
<a name="l01286"></a>01286 @end
<a name="l01287"></a>01287 @implementation NSArray(OOExtras)
<a name="l01288"></a>01288 - (NSString *)stringValue { 
<a name="l01289"></a>01289     static OOReplace reformat( "/(\\s)\\s+|^\\(|\\)$|\<span class="stringliteral">"/$1/"</span> );
<a name="l01290"></a>01290     <span class="keywordflow">return</span> &amp;([<span class="keyword">self</span> <a class="code" href="interface_o_o_record.html#6a162efb1943fbadaadf28d117eb6608">description</a>] | reformat);
<a name="l01291"></a>01291 }
<a name="l01292"></a>01292 <span class="keyword">@end</span>
<a name="l01293"></a>01293 
<a name="l01294"></a>01294 <span class="keyword">@interface </span>NSDictionary(OOExtras)
<a name="l01295"></a>01295 <span class="keyword">@end</span>
<a name="l01296"></a>01296 <span class="keyword">@implementation </span>NSDictionary(OOExtras)
<a name="l01297"></a>01297 - (NSString *)stringValue { 
<a name="l01298"></a>01298     <span class="keyword">static</span> <a class="code" href="class_o_o_replace.html">OOReplace</a> reformat( <span class="stringliteral">"/(\\s)\\s+|^\\{|\\}$|\"/$1/"</span> );
<a name="l01299"></a>01299     <span class="keywordflow">return</span> &amp;([<span class="keyword">self</span> description] | reformat);
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 <span class="keyword">@end</span>
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 <span class="preprocessor">#ifdef __IPHONE_OS_VERSION_MIN_REQUIRED</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span><span class="keyword">@interface </span>UISwitch(OOExtras)
<a name="l01305"></a>01305 <span class="keyword">@end</span>
<a name="l01306"></a>01306 <span class="keyword">@implementation </span>UISwitch(OOExtras)
<a name="l01307"></a>01307 - (NSString *)text { <span class="keywordflow">return</span> <span class="keyword">self</span>.on ? <span class="stringliteral">@"1"</span> : <span class="stringliteral">@"0"</span>; }
<a name="l01308"></a>01308 <span class="keyword">@end</span>
<a name="l01309"></a>01309 <span class="preprocessor">#endif</span>
<a name="l01310"></a>01310 <span class="preprocessor"></span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Nov 17 15:32:31 2009 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
